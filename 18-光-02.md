ç¬¬ä¸ƒç«  çº¹ç†æ˜ å°„

çº¹ç†æ˜ å°„å°±æ˜¯å°†çº¹ç†ä¸­çš„åƒç´ æ˜ å°„åˆ°æ¨¡å‹ç›¸åº”ä½ç½®çš„ç€è‰²ç‚¹ä¸Šã€‚

çº¹ç†ä¸­æ‰€å­˜å‚¨çš„åƒç´ ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºæ¨¡å‹çš„æ¼«åå°„ã€é•œé¢åå°„ã€é€æ˜åº¦ã€å‡¹å‡¸ç­‰ã€‚

çº¹ç†æ˜ å°„æ˜¯é€šè¿‡UV åæ ‡å®ç°çš„ã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè‹¥æ¨¡å‹æ˜¯ç”±å»ºæ¨¡å¸ˆæä¾›çš„ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è·Ÿä»–è¦ä¸€ä»½è´´å›¾çš„UV åæ ‡ã€‚

ç„¶è€Œï¼Œæœ‰äº›æ¨¡å‹æ˜¯éœ€è¦æˆ‘ä»¬åŠ¨æ€å»ºæ¨¡çš„ï¼Œè¿™ç§æ¨¡å‹æ‰€éœ€çš„UV åæ ‡å°±éœ€è¦æˆ‘ä»¬è‡ªå·±æ¥è®¡ç®—äº†ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸¤ä¸ªå¸¸è§çº¹ç†æ˜ å°„ã€‚



### 1-ç­‰è·åœ†æŸ±æŠ•å½±

#### 1-1-æ¦‚å¿µ

ä¹‹å‰æˆ‘ä»¬ç”»è¿‡ä¸€ä¸ªçƒä½“ï¼š

![image-20211102154524076](images/image-20211102154524076.png)



ç„¶åæˆ‘è¿˜ä»åŸºç»´ç™¾ç§‘ä¸Šæ‰¾äº†ä¸€å¼ åœ°çƒçš„ç­‰è·åœ†æŸ±æŠ•å½±è´´å›¾ï¼š

![earth](images/earth-1640664372317.jpg)



æ¥ä¸‹æ¥æˆ‘ä¾¿å¯ä»¥åˆ©ç”¨ç­‰è·æŠ•å½±è§„åˆ™æŠŠä¸Šé¢çš„è´´å›¾è´´åˆ°çƒä½“ä¸Šï¼š

![image-20211230195821579](images/image-20211230195821579.png)

å®ç°ä¸Šé¢è¿™ä¸ªæ•ˆæœçš„å…³é”®å°±æ˜¯çº¹ç†æ˜ å°„ï¼Œæˆ‘æ‰€ä½¿ç”¨çš„çº¹ç†æ˜ å°„æ–¹æ³•å°±æ˜¯ç­‰è·åœ†æŸ±æŠ•å½±ã€‚

ç­‰è·çš„æ„æ€å°±æ˜¯ä¸Šé¢çš„è´´å›¾é‡Œï¼Œæ¯ä¸ªæ ¼å­çš„å®½(çº¬çº¿)ã€é«˜(ç»çº¿)å°ºå¯¸éƒ½æ˜¯ç›¸ç­‰çš„ã€‚

åœ†æŸ±æŠ•å½±çš„æ„æ€æ˜¯ï¼Œç”¨åœ†æŸ±åŒ…è£¹çƒä½“ï¼Œåœ†æŸ±çš„é¢ä¸çƒä½“ç›¸åˆ‡ã€‚åœ¨çƒä½“ä¸­å¿ƒæ”¾ä¸€ä¸ªç‚¹å…‰æºï¼Œç‚¹å…‰æºä¼šæŠŠçƒä½“æŠ•å°„åˆ°åœ†æŸ±ä¸Šï¼Œä»è€Œå¾—åˆ°çƒä½“çš„åœ†æŸ±æŠ•å½±ã€‚

![image-20211228172109068](images/image-20211228172109068.png)



ç­‰è·åœ†æŸ±æŠ•å½±è´´å›¾ä¹Ÿå¯ä»¥ç†è§£ä¸ºçƒä½“å±•å¼€åçš„æ ·å­ã€‚

![image-20211229155709096](images/image-20211229155709096.png)



ç­‰è·åœ†æŸ±æŠ•å½±é™¤äº†å¯ä»¥ç”»åœ°çƒï¼Œå®ƒåœ¨VR ä¸­ä¹Ÿå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚

ç°åœ¨å¸‚é¢ä¸Šçš„720Â°å…¨æ™¯ç›¸æœºæ‹æ‘„å‡ºçš„å…¨æ™¯å›¾ç‰‡ï¼Œä¸€èˆ¬éƒ½æ˜¯ç­‰è·åœ†æŸ±æŠ•å½±å›¾ç‰‡ã€‚

![room](images/room.jpg)



ç­‰è·åœ†æŸ±æŠ•å½±çš„è®¡ç®—æŒºç®€å•çš„ï¼Œå’±ä»¬ä¹‹å‰è¯´çƒåæ ‡ç³»çš„æ—¶å€™å°±å·²ç»ä¸ºå…¶æ‰“å¥½äº†åŸºç¡€ã€‚



#### 1-2-åœ°ç†åæ ‡ç³»

åœ°ç†åæ ‡ç³»(Geographic coordinate system) å°±æ˜¯ä¸€ç§çƒåæ ‡ç³»(Spherical coordinate system)ã€‚

åœ°ç†åæ ‡ç³»å’Œthree.js é‡Œçš„Spherical çƒåæ ‡ç³»å·®ä¸å¤šï¼Œåªæ˜¯åœ¨Î¸å’ŒÏ†çš„å®šä¹‰ä¸Šç•¥æœ‰å·®å¼‚ã€‚

Spherical çƒåæ ‡ç³»é‡Œçš„æ–¹ä½è§’Î¸å’Œæè§’Ï†çš„å®šä¹‰è§„åˆ™ï¼š

- Î¸ èµ·å§‹äºzè½´çš„æ­£åŠè½´ï¼Œé€†æ—¶é’ˆæ—‹è½¬ï¼Œæ—‹è½¬é‡è¶Šå¤§Î¸ å€¼è¶Šå¤§ï¼Œ0 â‰¤ Î¸  < 2Ï€
- Ï† èµ·å§‹äºyè½´çš„æ­£åŠè½´ï¼Œå‘ä¸‹æ—‹è½¬ï¼Œæ—‹è½¬é‡è¶Šå¤§Ï† å€¼è¶Šå¤§ï¼Œ0 â‰¤ Ï† < Ï€

ä¸‹å›¾æ˜¯åœ°ç†åæ ‡ç³»ï¼š

![image-20211230174103163](images/image-20211230174103163.png)



- Î¸ å¯¹åº”ç»åº¦ï¼Œèµ·å§‹äºxè½´çš„æ­£åŠè½´ï¼Œå³æœ¬åˆå­åˆçº¿çš„ä½ç½®ï¼ŒÎ¸=0
  - ä»0Â° é€†æ—¶é’ˆæ—‹è½¬ï¼Œæ—‹è½¬é‡è¶Šå¤§Î¸ å€¼è¶Šå¤§ï¼Œæ—‹è½¬åˆ°180Â°ç»“æŸï¼Œæ˜¯ä¸ºä¸œç»ï¼Œ0 â‰¤ Î¸  < Ï€
  - ä»0Â° é¡ºæ—¶é’ˆæ—‹è½¬ï¼Œæ—‹è½¬é‡è¶Šå¤§Î¸ å€¼è¶Šå°ï¼Œæ—‹è½¬åˆ°-180Â°ç»“æŸï¼Œæ˜¯ä¸ºè¥¿ç»ï¼Œ0 â‰¤ Î¸  < -Ï€
- Ï† å¯¹åº”ç»´åº¦ï¼Œèµ·å§‹äºèµ¤é“ï¼ŒÏ†=0
  - ä»0Â° å‘ä¸Šæ—‹è½¬ï¼Œæ—‹è½¬é‡è¶Šå¤§Ï† å€¼è¶Šå¤§ï¼Œæ—‹è½¬åˆ°90Â°ç»“æŸï¼Œæ˜¯ä¸ºåŒ—çº¬ï¼Œ0 â‰¤ Ï† < Ï€/2
  - ä»0Â° å‘ä¸‹æ—‹è½¬ï¼Œæ—‹è½¬é‡è¶Šå¤§Ï† å€¼è¶Šå°ï¼Œæ—‹è½¬åˆ°-90Â°ç»“æŸï¼Œæ˜¯ä¸ºå—çº¬ï¼Œ0 â‰¤ Ï† < -Ï€/2

å¯¹äºå·²çŸ¥ä¸€ç‚¹çš„ç»çº¬åº¦ï¼Œæ±‚æ­¤ç‚¹çš„ä¸‰ç»´ç›´è§’åæ ‡ä½çš„æ–¹æ³•ï¼Œä¸Šå›¾å·²ç»è¯¦ç»†ç”»å‡ºã€‚



#### 1-3-ç»çº¬åº¦ä¸ç­‰è·åœ†æŸ±æŠ•å½±è´´å›¾çš„çº¿æ€§æ˜ å°„

é€šè¿‡ä¸Šé¢ç»çº¬åº¦çš„å®šä¹‰è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š

- ç»åº¦å’ŒUå€¼ç›¸æ˜ å°„
- ç»´åº¦å’ŒVå€¼ç›¸æ˜ å°„

å…¶å…·ä½“çš„æ˜ å°„æ˜ å°„æ–¹å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20211230190455088](images/image-20211230190455088.png)



- ç»åº¦[-Ï€,Ï€] æ˜ å°„u[0,1]
- ç»´åº¦[-Ï€/2,Ï€/2] æ˜ å°„v[0,1]



#### 1-4-ç»˜åˆ¶åœ°çƒ

1.å»ºç«‹ä¸€ä¸ªåœ°ç†åæ ‡ç³»Geographyå¯¹è±¡ï¼Œæ–¹ä¾¿æŠŠç»çº¬åº¦è½¬ä¸‰ç»´ç›´è§’åæ ‡ã€‚

```js
import {Vector3} from 'https://unpkg.com/three/build/three.module.js';

/*
å±æ€§ï¼š
  rï¼šåŠå¾„
  longitudeï¼šç»åº¦(å¼§åº¦)
  latitudeï¼šçº¬åº¦(å¼§åº¦)
  positionï¼šä¸‰ç»´åæ ‡ä½

æ„é€ å‚æ•°ï¼š
  r,longitude,latitude 
  æˆ–è€…
  position
*/
export default class Geography{
  constructor(r=1,longitude=0, latitude=0){
    this.r=r
    this.longitude=longitude
    this.latitude = latitude
    this.position=new Vector3()
    this.updatePos()
  }
  //å…‹éš†
  clone() {
    const { r, longitude, latitude } = this
    return new Geography(r, longitude, latitude)
  }
  //è®¾ç½®åŠå¾„ï¼Œæ›´æ–°ä¸‰ç»´ç›´è§’åæ ‡ä½
  setR(r) {
    this.r = r
    this.updatePos()
    return this
  }
  //æ ¹æ®ç»çº¬åº¦æ›´æ–°ä¸‰ç»´ç›´è§’åæ ‡ä½
  updatePos() {
    const { r,longitude,latitude } = this
    const len = Math.cos(latitude) * r
    this.position.set(
      Math.cos(longitude)*len,
      Math.sin(latitude)*r,
      -Math.sin(longitude)*len
    )
  }
}

```



2.å»ºæ¨¡

ä¹‹å‰æˆ‘ä»¬ç”»è¿‡ä¸€ä¸ªçƒä½“Sphere.jsï¼Œåªä¸è¿‡è¿™ä¸ªçƒä½“çš„å—æå’ŒåŒ—æå…±ç”¨ä¸€ä¸ªé¡¶ç‚¹ï¼Œä¸é€‚åˆåšæŸ±çŠ¶æŠ•å½±è´´å›¾ã€‚

æ¥ä¸‹æ¥ï¼Œå’±ä»¬åœ¨å…¶åŸºç¡€ä¸Šå†æ”¹è£…ä¸€ä¸ªçƒä½“Earthå‡ºæ¥ï¼Œè¿™ä¸ªEarthå¯¹è±¡æ˜¯æŒ‰ç…§çŸ©å½¢ç½‘æ ¼å»ºæ¨¡çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220105221203518](images/image-20220105221203518.png)



å½“å‰è¿™ä¸ªEarthå¯¹è±¡æ˜¯ç›´æ¥æŒ‰ç…§çŸ©å½¢ç½‘æ ¼å»ºæ¨¡çš„ã€‚

```js
import Geography from './Geography.js'

/*
å±æ€§ï¼š
  rï¼šåŠå¾„
  widthSegmentsï¼šæ¨ªå‘æ®µæ•°ï¼Œæœ€å°3ç«¯
  heightSegmentsï¼šçºµå‘æ®µæ•°ï¼Œæœ€å°2ç«¯
  verticesï¼šé¡¶ç‚¹é›†åˆ
  normalsï¼šæ³•çº¿é›†åˆ
  indexesï¼šé¡¶ç‚¹ç´¢å¼•é›†åˆ
  uvï¼šuvåæ ‡
  countï¼šé¡¶ç‚¹æ•°é‡
*/
export default class Earth{
  constructor(r=1, widthSegments=3, heightSegments=2){
    this.r=r
    this.widthSegments=widthSegments
    this.heightSegments=heightSegments
    this.vertices=[]
    this.normals=[]
    this.indexes = []
    this.uv=[]
    this.count=0
    this.init()
  }
  init() {
    const {r,widthSegments, heightSegments } = this
    //ç½‘æ ¼çº¿çš„æ•°é‡
    const [width,height]=[widthSegments+1,heightSegments +1]
    //é¡¶ç‚¹æ•°é‡
    this.count = width*height
    // thetaå’Œphiæ–¹å‘çš„æ—‹è½¬å¼§åº¦
    const thetaSize = Math.PI * 2 / widthSegments
    const phiSize = Math.PI / heightSegments

    // é¡¶ç‚¹é›†åˆ
    const vertices = []
    // æ³•çº¿é›†åˆ
    const normals = []
    // é¡¶ç‚¹ç´¢å¼•é›†åˆ
    const indexes = []
    //uv åæ ‡é›†åˆ
    const uv=[]
    // é€è¡Œåˆ—éå†
    for (let y = 0; y < height; y++) {
      // ç»´åº¦ 
      const phi = Math.PI/2-phiSize * y
      for (let x = 0; x < width; x++) {
        //ç»åº¦ï¼Œ-Math.PIæ˜¯ä¸ºäº†è®©0Â°ç»çº¿ç»è¿‡xè½´çš„æ­£åŠè½´
        const theta = thetaSize * x-Math.PI
        // è®¡ç®—é¡¶ç‚¹å’Œæ³•çº¿
        const vertice = new Geography(r,theta,phi).position
        vertices.push(...Object.values(vertice))
        normals.push(...Object.values(vertice.normalize()))
        const [u, v] = [
          x / widthSegments,
          1-y/heightSegments
        ]
        uv.push(u, v)
        // é¡¶ç‚¹ç´¢å¼•
        if (y && x) {
          // ä¸€ä¸ªçŸ©å½¢æ ¼å­çš„å·¦ä¸Šltã€å³ä¸Šrtã€å·¦ä¸‹lbã€å³ä¸‹rbç‚¹
          const lt = (y-1) * width + (x-1)
          const rt = (y-1) * width + x
          const lb = y * width + (x-1)
          const rb = y * width + x
          indexes.push(lb, rb, lt, lt, rb, rt)
        }
      }
    }
    this.vertices=new Float32Array(vertices)
    this.normals=new Float32Array(normals)
    this.uv=new Float32Array(uv)
    this.indexes=new Uint16Array(indexes)
  }
}

```



3.ç€è‰²å™¨

```html
<script id="vs" type="x-shader/x-vertex">
  attribute vec4 a_Position;
  attribute vec2 a_Pin;
  uniform mat4 u_PvMatrix;
  uniform mat4 u_ModelMatrix;
  varying vec2 v_Pin;
  void main(){
    gl_Position=u_PvMatrix*u_ModelMatrix*a_Position;
    v_Pin=a_Pin;
  }
</script>
<script id="fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D u_Sampler;
  varying vec2 v_Pin;
  void main(){
    gl_FragColor=texture2D(u_Sampler,v_Pin);
  }
</script>

```



3.è´´å›¾

```js
import { createProgram, } from "/jsm/Utils.js";
import {
  Matrix4, PerspectiveCamera, Vector3
} from 'https://unpkg.com/three/build/three.module.js';
import OrbitControls from './lv/OrbitControls.js'
import Mat from './lv/Mat.js'
import Geo from './lv/Geo.js'
import Obj3D from './lv/Obj3D.js'
import Scene from './lv/Scene.js'
import Earth from './lv/Earth.js'

const canvas = document.getElementById('canvas');
canvas.width = window.innerWidth
canvas.height = window.innerHeight
const gl = canvas.getContext('webgl');

// çƒä½“
const earth = new Earth(0.5, 64, 32)

// ç›®æ ‡ç‚¹
const target = new Vector3()
//è§†ç‚¹
const eye = new Vector3(2, 0, 0)
const [fov, aspect, near, far] = [
  45, canvas.width / canvas.height,
  0.1, 5
]
// é€è§†ç›¸æœº
const camera = new PerspectiveCamera(fov, aspect, near, far)
camera.position.copy(eye)
// è½¨é“æ§åˆ¶å™¨
const orbit = new OrbitControls({ camera, target, dom: canvas, })

// åœºæ™¯
const scene = new Scene({ gl })
//æ³¨å†Œç¨‹åºå¯¹è±¡
scene.registerProgram(
  'map',
  {
    program: createProgram(
      gl,
      document.getElementById('vs').innerText,
      document.getElementById('fs').innerText,
    ),
    attributeNames: ['a_Position', 'a_Pin'],
    uniformNames: ['u_PvMatrix', 'u_ModelMatrix','u_Sampler']
  }
)

//åœ°çƒ
const matEarth = new Mat({
  program: 'map',
  data: {
    u_PvMatrix: {
      value: orbit.getPvMatrix().elements,
      type: 'uniformMatrix4fv',
    },
    u_ModelMatrix: {
      value: new Matrix4().elements,
      type: 'uniformMatrix4fv',
    },
  },
})
const geoEarth = new Geo({
  data: {
    a_Position: {
      array: earth.vertices,
      size: 3
    },
    a_Pin: {
      array: earth.uv,
      size: 2
    }
  },
  index: {
    array: earth.indexes
  }
})

//åŠ è½½å›¾ç‰‡
const image = new Image()
image.src = './images/earth.jpg'
image.onload = function () {
  matEarth.maps.u_Sampler = { image }
  scene.add(new Obj3D({
    geo: geoEarth,
    mat: matEarth
  }))
  render()
}

// è¿ç»­æ¸²æŸ“
function render(time = 0) {
  orbit.getPvMatrix()
  scene.draw()
  requestAnimationFrame(render)
}

/* å–æ¶ˆå³å‡»èœå•çš„æ˜¾ç¤º */
canvas.addEventListener('contextmenu', event => {
  event.preventDefault()
})
/* æŒ‡é’ˆæŒ‰ä¸‹æ—¶ï¼Œè®¾ç½®æ‹–æ‹½èµ·å§‹ä½ï¼Œè·å–è½¨é“æ§åˆ¶å™¨çŠ¶æ€ã€‚ */
canvas.addEventListener('pointerdown', event => {
  orbit.pointerdown(event)
})
/* æŒ‡é’ˆç§»åŠ¨æ—¶ï¼Œè‹¥æ§åˆ¶å™¨å¤„äºå¹³ç§»çŠ¶æ€ï¼Œå¹³ç§»ç›¸æœºï¼›è‹¥æ§åˆ¶å™¨å¤„äºæ—‹è½¬çŠ¶æ€ï¼Œæ—‹è½¬ç›¸æœºã€‚ */
canvas.addEventListener('pointermove', event => {
  orbit.pointermove(event)
})
/* æŒ‡é’ˆæŠ¬èµ· */
canvas.addEventListener('pointerup', event => {
  orbit.pointerup(event)
})
/* æ»šè½®äº‹ä»¶ */
canvas.addEventListener('wheel', event => {
  orbit.wheel(event)
})

```

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20211230195821579](images/image-20211230195821579.png)



åˆ°ç°åœ¨ï¼Œå¤§å®¶åº”è¯¥å¯¹ç­‰è·åœ†æŸ±æŠ•å½±æœ‰äº†ä¸€ä¸ªæ•´ä½“çš„è®¤çŸ¥ã€‚

æ¥ä¸‹æˆ‘ä»¬å°±å¯ä»¥å†åšä¸€ä¸‹æ‰©å±•ï¼Œæ ¹æ®ç»çº¬åº¦ï¼Œä¸ºæŸä¸ªåœ°ç‚¹åšæ ‡è®°ã€‚



#### 1-5-æ ‡è®°ç‚¹

æˆ‘åœ¨ç™¾åº¦åœ°å›¾é‡Œæ‹¿åˆ°äº†å¤©å®‰é—¨çš„ç»çº¬åº¦(116.404,39.915)ï¼Œå…¶æ„æ€å°±æ˜¯ä¸œç»116.404Â°, åŒ—çº¬39.915Â°

æˆ‘ä»¬ä½¿ç”¨Geography å¯¹è±¡ä¾¿å¯ä»¥å°†ç»çº¬åº¦è½¬ä¸‰ç»´ç›´è§’åæ ‡ä½ï¼Œç„¶åå†æ ¹æ®è¿™ä¸ªä¸‰ç»´ç›´è§’åæ ‡ä½åšä¸ªæ ‡è®°å³å¯ã€‚

![image-20220103113657531](images/image-20220103113657531.png)

æ ‡è®°ç‚¹çš„åˆ¶ä½œæ€è·¯æœ‰ä¸¤ç§ï¼š

- ç”¨<img>ä¹‹ç±»çš„HTMLæ ‡ç­¾å®ç°ã€‚
  - ä¼˜ç‚¹ï¼šåˆ¶ä½œä¾¿æ·ï¼Œå°¤å…¶æ˜¯è¦ä¸ºå…¶æ·»åŠ æ–‡å­—çš„æ—¶å€™ã€‚
  - ç¼ºç‚¹ï¼šè¦å°†æ ‡è®°ç‚¹åœ¨webgl è£å‰ªç©ºé—´åæ ‡ä½è½¬æ¢åˆ°css åæ ‡ä½ã€‚éœ€è¦é¢å¤–è€ƒè™‘æ ‡è®°ç‚¹ä¸æ¨¡å‹çš„é®æŒ¡é—®é¢˜ã€‚
- åœ¨webgl ä¸­å®ç°ã€‚
  - ä¼˜ç‚¹ï¼šæ ‡è®°ç‚¹æ“ä½œæ–¹ä¾¿ï¼Œæ¨¡å‹é®æŒ¡å®ç°ä¾¿æ·ã€‚
  - ç¼ºç‚¹ï¼šè‹¥æ ‡è®°ç‚¹ä¸­å­˜åœ¨æ–‡å­—ï¼Œéœ€åšé¢å¤–è€ƒé‡ã€‚

å¯¹äºæ–‡å­—æ ‡è®°çš„æ˜¾ç¤ºé—®é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸è¯´ï¼Œåé¢ä¼šå•ç‹¬è¯¦è§£ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆç”¨webgl åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºä¸€ä¸ªä¸å¸¦æ–‡å­—çš„æ ‡è®°ç‚¹ã€‚

1.å»ºç«‹ä¸€ä¸ªçŸ©å½¢é¢å¯¹è±¡ï¼Œæ–¹ä¾¿ä¹‹åæŠŠæ ‡è®°ç‚¹ä½œä¸ºè´´å›¾è´´ä¸Šå»ã€‚

```js
import {Vector2} from 'https://unpkg.com/three/build/three.module.js';

/*
å±æ€§ï¼š
  size:å°ºå¯¸
  orign:åŸºç‚¹ï¼Œç™¾åˆ†æ¯”ï¼Œé»˜è®¤å·¦ä¸‹è§’
  verticesï¼šé¡¶ç‚¹é›†åˆ
  normalsï¼šæ³•çº¿é›†åˆ
  indexesï¼šé¡¶ç‚¹ç´¢å¼•é›†åˆ
  uvï¼šuvåæ ‡
*/
export default class Rect{
  constructor(w=1, h=1,x=0,y=0){
    this.size=new Vector2(w,h)
    this.orign=new Vector2(x,y)
    this.vertices=[]
    this.normals=[]
    this.indexes = []
    this.uv=[]
    this.update()
  }
  update() {
    const { size, orign } = this
    const l=-orign.x*size.x
    const b =-orign.y * size.y
    const r=size.x+l
    const t=size.y+b
    
    this.vertices = new Float32Array([
      l, t, 0,
      l, b, 0,
      r, t, 0,
      r, b, 0,
    ])
    this.normals = new Float32Array([
      0,0,1,
      0,0,1,
      0,0,1,
      0,0,1,
    ])
    this.uv = new Float32Array([
      0, 1,
      0, 0,
      1, 1,
      1, 0
    ])
    this.indexes = new Uint16Array([
      0, 1, 2,
      2,1,3
    ])
  }
}

```

æ¥ä¸‹æ¥ï¼ŒåŸºäºä¹‹å‰åœ†æŸ±æŠ•å½±æ–‡ä»¶ç•¥ä½œè°ƒæ•´ã€‚



2.å®ä¾‹åŒ–Rect å¯¹è±¡

```js
import Rect from './lv/Rect.js'
â€¦â€¦
gl.enable(gl.BLEND);
gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
â€¦â€¦
// çŸ©å½¢é¢
const rect = new Rect(0.02, 0.02, 0.5, 0)

```



3.åŸºäºå¤©å®‰é—¨ç»çº¬åº¦ï¼Œå»ºç«‹Geography å¯¹è±¡ã€‚

```js
const rad = Math.PI / 180
const geography = new Geography(
  earth.r,
  116.404 * rad,
  39.915 * rad
)

```



4.è®©ç›¸æœºçš„è§†ç‚¹ç›´è§†å¤©é—¨ã€‚

```js
const eye = geography.clone()
      .setR(earth.r + 1)
      .position

```



5.åŸºäºæ ‡è®°ç‚¹çš„ä¸‰ç»´ç›´è§’åæ ‡ä½æ„å»ºä¸€ä¸ªæ¨¡å‹çŸ©é˜µ

```js
const modelMatrix = new Matrix4()
	.setPosition(geography.position)

```



6.å»ºç«‹æ ‡è®°ç‚¹çš„Matå’ŒGeo å¯¹è±¡

```js
const matMark = new Mat({
  program: 'map',
  data: {
    u_PvMatrix: {
      value: orbit.getPvMatrix().elements,
      type: 'uniformMatrix4fv',
    },
    u_ModelMatrix: {
      value: modelMatrix.elements,
      type: 'uniformMatrix4fv',
    },
  },
})
const geoMark = new Geo({
  data: {
    a_Position: {
      array: rect.vertices,
      size: 3
    },
    a_Pin: {
      array: rect.uv,
      size: 2
    }
  },
  index: {
    array: rect.indexes
  }
})

```



7.å½“æ‰€æœ‰è´´å›¾éƒ½åŠ è½½æˆåŠŸåï¼Œå°†è´´å›¾ä¼ ç»™ç›¸åº”çš„Mat å¯¹è±¡ã€‚ç„¶åå»ºç«‹åœ°çƒå’Œæ ‡è®°ç‚¹æ‰€å¯¹åº”çš„Obj3Då¯¹è±¡ï¼Œå°†å…¶æ·»åŠ åˆ°Scene åœºæ™¯ä¸­ï¼Œè¿›è¡Œæ¸²æŸ“ã€‚

```js
//åŠ è½½å›¾å½¢
const imgPromises = ['earth.jpg', 'mark.png'].map(name => {
  const img = new Image()
  img.src = `./images/${name}`
  return imgPromise(img)
})
Promise.all(imgPromises).then((imgs) => {
  matEarth.maps.u_Sampler = { image: imgs[0] }
  matMark.maps.u_Sampler = {
    image: imgs[1],
    format: gl.RGBA
  }
  scene.add(new Obj3D({
    geo: geoEarth,
    mat: matEarth
  }))
  scene.add(new Obj3D({
    geo: geoMark,
    mat: matMark
  }))
  render()
})

// è¿ç»­æ¸²æŸ“
function render(time = 0) {
  orbit.getPvMatrix()
  scene.draw()
  requestAnimationFrame(render)
}

```



8.è®©æ ‡è®°ç‚¹è´´åˆåˆ°åœ°çƒè¡¨é¢

```js
const modelMatrix = new Matrix4()
      .setPosition(geography.position)
      .multiply(
        new Matrix4().lookAt(
          geography.position,
          target,
          new Vector3(0, 1, 0)
        )
      )

```

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

![image-20220103124157493](images/image-20220103124157493.png)

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå›´ç»•åœ°çƒï¼Œæ˜¯å¯ä»¥åšå¾ˆå¤šä¸œè¥¿ã€‚

æ¯”å¦‚åœ¨çƒä½“ä¸Šç»˜åˆ¶æŸ±çŠ¶å›¾ï¼Œè¡¨ç¤ºä¸åŒåœ°åŒºçš„ç»æµå¢é•¿æƒ…å†µï¼›

åœ¨ä¸¤ä¸ªåœ°ç‚¹ä¹‹é—´ç»˜åˆ¶3Dè·¯å¾„ï¼Œä»¥è¡¨ç¤ºä¸¤åœ°ä¹‹é—´å­˜åœ¨çš„è”ç³»ï¼›

å¯¹äºè¿™äº›æ•ˆæœï¼Œæˆ‘ä»¬å°±å…ˆä¸åšæ‰©å±•äº†ï¼Œç­‰ç»“è¯¾äº†å†è·Ÿå¤§å®¶æ…¢æ…¢è¯´ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘åœ¨æŠŠç›¸æœºå¡è¿›åœ°çƒé‡Œï¼Œåšä¸€ä¸ªVRçš„æ•ˆæœã€‚





### 2-VR

VR(Virtual Reality) çš„æ„æ€å°±æ˜¯è™šæ‹Ÿç°å®ï¼Œå¯ä»¥é€šè¿‡VR çœ¼é•œç»™äººç¯å¢ƒæ²‰æµ¸æ„Ÿã€‚

VR çš„åˆ¶ä½œéœ€è¦è€ƒè™‘ä¸¤ç‚¹ï¼š

- æ­å»ºåœºæ™¯ï¼Œå½“å‰æ¯”è¾ƒå¸¸è§çš„æ­å»ºåœºæ™¯çš„æ–¹æ³•å°±æ˜¯å°†å…¨æ™¯å›¾è´´åˆ°ç«‹æ–¹ä½“ï¼Œæˆ–è€…çƒä½“ä¸Šã€‚
- åœºæ™¯å˜æ¢ï¼Œä¸€èˆ¬ä¼šæŠŠé€è§†ç›¸æœºå¡è¿›ç«‹æ–¹ä½“ï¼Œæˆ–è€…çƒä½“é‡Œï¼Œç„¶åå˜æ¢åœºæ™¯ã€‚

æ¥ä¸‹æ¥å’±ä»¬ å…·ä½“è¯´ä¸€ä¸‹å…¶å®ç°æ­¥éª¤ã€‚

#### 2-1-æ­å»ºåœºæ™¯

1.ç”¨720Â°å…¨æ™¯ç›¸æœºæ‹æ‘„ä¸€å¼ å®¤å†…å…¨æ™¯å›¾ã€‚

![room](images/room.jpg)



2.åœ¨ä¹‹å‰åœ°çƒæ–‡ä»¶çš„åŸºç¡€ä¸Šåšä¿®æ”¹ï¼ŒæŠŠåœ°å›¾æ›¿æ¢æˆä¸Šé¢çš„å®¤å†…å…¨æ™¯å›¾ã€‚

```js
const image = new Image()
image.src = './images/room.jpg'

```



3.æŠŠç›¸æœºæ‰“å…¥çƒä½“ä¹‹ä¸­

```js
// ç›®æ ‡ç‚¹
const target = new Vector3()
//è§†ç‚¹
const eye = new Vector3(0.15, 0, 0)
const [fov, aspect, near, far] = [
  60, canvas.width / canvas.height,
  0.1, 1
]

```

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220107131904449](images/image-20220107131904449.png)

ç°åœ¨VRçš„æ•ˆæœå°±å·²ç»æœ‰äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘VR åœºæ™¯çš„å˜æ¢ã€‚



#### 2-2-VR åœºæ™¯çš„å˜æ¢

VR åœºæ™¯çš„å˜æ¢é€šè¿‡ç›¸æœºè½¨é“æ§åˆ¶å™¨ä¾¿å¯ä»¥å®ç°ã€‚

å½“å‰ç›¸æœºè½¨é“æ§åˆ¶å™¨å·²ç»å…·å¤‡äº†æ—‹è½¬ã€ç¼©æ”¾å’Œå¹³ç§»åŠŸèƒ½ã€‚

åªä¸è¿‡ï¼Œé’ˆå¯¹VR è¿˜å¾—å¯¹ç›¸æœºè½¨é“æ§åˆ¶å™¨åšä¸€ä¸‹å¾®è°ƒã€‚

1.å–æ¶ˆç›¸æœºçš„å¹³ç§»ï¼Œä»¥é¿å…ç›¸æœºè·‘åˆ°çƒä½“ä¹‹å¤–ã€‚

ä¸ºç›¸æœºè½¨é“æ§åˆ¶å™¨ OrbitControls æ·»åŠ ä¸€ä¸ªæ˜¯å¦å¯ç”¨å¹³ç§»çš„åŠŸèƒ½ã€‚

```js
const defAttr = () => ({
  â€¦â€¦
  enablePan: true,
})


```

åœ¨å¹³ç§»æ–¹æ³•ä¸­ï¼Œåšä¸ªæ˜¯å¦å¹³ç§»çš„åˆ¤æ–­ï¼š

```js
pointermove({ clientX, clientY }) {
  const { dragStart, dragEnd, state,enablePan, camera: { type } } = this
  dragEnd.set(clientX, clientY)
  switch (state) {
    case 'pan':
      enablePan&&this[`pan${type}`] (dragEnd.clone().sub(dragStart))
      break
    â€¦â€¦
  }
  dragStart.copy(dragEnd)
}

```

è¿™æ ·å°±å¯ä»¥åœ¨å®ä¾‹åŒ–OrbitControls å¯¹è±¡çš„æ—¶å€™ï¼Œå°†enablePan è®¾ç½®ä¸ºfalseï¼Œä»è€Œç¦æ­¢ç›¸æœºå¹³ç§»ã€‚

```js
const orbit = new OrbitControls({
  camera,
  target,
  dom: canvas,
  enablePan: false
})

```



2.ä½¿ç”¨é€è§†ç›¸æœºç¼©æ”¾VR åœºæ™¯æ—¶ï¼Œä¸å†ä½¿ç”¨è§†ç‚¹åˆ°ç›®æ ‡çš„è·ç¦»æ¥ç¼©æ”¾åœºæ™¯ï¼Œå› ä¸ºè¿™æ ·çš„æ”¾å¤§æ•ˆæœä¸å¤ªæ˜æ˜¾ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ç›´æ¥åƒæ­£äº¤ç›¸æœºé‚£æ ·ï¼Œç¼©æ”¾è£å‰ªé¢ã€‚

ä¸ºOrbitControls å¯¹è±¡çš„wheel æ–¹æ³•æ·»åŠ ä¸€ä¸ªæ§åˆ¶ç¼©æ”¾æ–¹å¼çš„å‚æ•°ã€‚

```js
wheel({ deltaY },type=this.camera.type) {
  const { zoomScale} = this
  let scale=deltaY < 0?zoomScale:1 / zoomScale
  this[`dolly${type}`] (scale)
  this.updateSph()
}

```

è¿™æ ·å°±å¯ä»¥åƒç¼©æ”¾æ­£äº¤ç›¸æœºé‚£æ ·ç¼©æ”¾é€è§†ç›¸æœºã€‚

```js
canvas.addEventListener('wheel', event => {
  orbit.wheel(event, 'OrthographicCamera')
})

```



3.åœ¨ç¼©æ”¾çš„æ—¶å€™ï¼Œéœ€è¦é™åˆ¶ä¸€ä¸‹ç¼©æ”¾èŒƒå›´ï¼Œå…å¾—ç¼©æ”¾å¾—å¤ªå¤§ï¼Œæˆ–è€…ç¼©å°å¾—è¶…å‡ºäº†çƒä½“ä¹‹å¤–ã€‚

ä¸ºOrbitControls æ·»åŠ ä¸¤ä¸ªç¼©æ”¾æå€¼ï¼š

- minZoom ç¼©æ”¾çš„æœ€å°å€¼
- maxZoom ç¼©æ”¾çš„æœ€å¤§å€¼

```js
const defAttr = () => ({
  â€¦â€¦
  minZoom:0,
  maxZoom: Infinity,
})

```

åœ¨ç›¸åº”çš„ç¼©æ”¾æ–¹æ³•ä¸­ï¼Œå¯¹ç¼©æ”¾é‡åšé™åˆ¶ï¼š

```js
dollyOrthographicCamera(dollyScale) {
  const {camera,maxZoom,minZoom}=this
  const zoom=camera.zoom*dollyScale
  camera.zoom = Math.max(
    Math.min(maxZoom, zoom),
    minZoom
  )
  camera.updateProjectionMatrix()
}

```

åœ¨å®ä¾‹åŒ–OrbitControls å¯¹è±¡æ—¶ï¼Œè®¾ç½®ç¼©æ”¾èŒƒå›´ï¼š

```js
const orbit = new OrbitControls({
  â€¦â€¦
  maxZoom: 15,
  minZoom: 0.4
})

```





#### 2-3-é™€èºä»ª

VR çš„çœŸæ­£é­…åŠ›åœ¨äºï¼Œä½ å¯ä»¥å¸¦ä¸ŠVR çœ¼é•œï¼Œä½“ä¼šèº«ä¸´å…¶å¢ƒçš„æ„Ÿè§‰ã€‚

VR çœ¼é•œä¹‹æ‰€ä»¥èƒ½ç»™ä½ èº«ä¸´å…¶å¢ƒçš„æ„Ÿè§‰ï¼Œæ˜¯å› ä¸ºå®ƒå†…éƒ¨æœ‰ä¸€ä¸ªé™€èºä»ªï¼Œå¯ä»¥ç›‘å¬è®¾å¤‡çš„è½¬åŠ¨ï¼Œä»è€Œå¸¦åŠ¨VR åœºæ™¯çš„å˜æ¢ã€‚

ç›®å‰å¸‚åœºä¸Šå¸¸è§çš„VR çœ¼é•œæœ‰ä¸¤ç§ï¼šéœ€è¦æ’å…¥æ‰‹æœºçš„VRçœ¼é•œå’Œä¸€ä½“æœºã€‚

ä¸€èˆ¬æ‰‹æœºé‡Œéƒ½æ˜¯æœ‰é™€èºä»ªçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨æ‰‹æœºæ¥ä½“éªŒVRã€‚

æ¥ä¸‹æ¥ï¼Œå’±ä»¬å¯ä»¥å…ˆæ•´ä¸ªå°ä¾‹å­ç»ƒç»ƒæ‰‹ã€‚

æˆ‘è¦ç”»ä¸ªç«‹æ–¹ä½“ï¼Œç„¶åç”¨é™€èºä»ªæ—‹è½¬å®ƒã€‚

ä¸ºäº†æ›´å¥½çš„ç†è§£é™€èºä»ªã€‚æˆ‘ä»¬æŠŠä¹‹å‰çš„çƒä½“å˜æˆç«‹æ–¹ä½“ï¼Œåœ¨å…¶ä¸Šé¢è´´ä¸Šç”»æœ‰ä¸œã€è¥¿ã€å—ã€åŒ—å’Œä¸Šã€ä¸‹çš„è´´å›¾ã€‚ç„¶ååœ¨å…¶ä¸­æ‰“å…¥ç›¸æœºï¼Œç”¨é™€èºä»ªå˜æ¢ç›¸æœºè§†ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š

 ![image-20220221161544961](images/image-20220221161544961.png)



1.å»ºç«‹ç«‹æ–¹ä½“å¯¹è±¡Box

```js
/*
å±æ€§ï¼š
  wï¼šå®½
  hï¼šé«˜
  dï¼šæ·±
  verticesï¼šé¡¶ç‚¹é›†åˆ
  normalsï¼šæ³•çº¿é›†åˆ
  indexesï¼šé¡¶ç‚¹ç´¢å¼•é›†åˆ
  uvï¼šuvåæ ‡é›†åˆ
  countï¼šé¡¶ç‚¹æ•°é‡
*/
export default class Box{
  constructor(w=1,h=1,d=1){
    this.w=w
    this.h=h
    this.d=d
    this.vertices=null
    this.normals=null
    this.indexes = null
    this.uv = null
    this.count = 36
    this.init()
  }
  init() {
    const [x, y, z] = [this.w / 2, this.h / 2, this.d / 2]
    this.vertices = new Float32Array([
      // å‰ 0 1 2 3
      -x, y, z, -x, -y, z, x, y, z, x, -y, z,
      // å³ 4 5 6 7
      x, y, z, x, -y, z, x, y, -z, x, -y, -z,
      // å 8 9 10 11
      x, y, -z, x, -y, -z, -x, y, -z, -x, -y, -z,
      // å·¦ 12 13 14 15 
      -x, y, -z, -x, -y, -z, -x, y, z, -x, -y, z,
      // ä¸Š 16 17 18 19
      -x, y, -z, -x, y, z, x, y, -z, x, y, z,
      // ä¸‹ 20 21 22 23 
      -x,-y,z,-x,-y,-z,x,-y,z,x,-y,-z,
    ])
    this.normals = new Float32Array([
      0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
      1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0,
      0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 
      -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0,
      0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0,
      0,-1,0,0,-1,0,0,-1,0,0,-1,0,
    ])
    /* this.uv = new Float32Array([
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
      0,1,0,0,1,1,1,0,
    ]) */
    this.uv = new Float32Array([
      0,1, 0,0.5, 0.25,1, 0.25,0.5,
      0.25,1, 0.25,0.5, 0.5,1, 0.5,0.5,
      0.5,1, 0.5,0.5, 0.75,1, 0.75,0.5,
      0,0.5,0,0,0.25,0.5,0.25,0,
      0.25,0.5,0.25,0,0.5,0.5,0.5,0,
      0.5,0.5,0.5,0,0.75,0.5,0.75,0,
    ])
    this.indexes = new Uint16Array([
      0, 1, 2, 2, 1, 3,
      4, 5, 6, 6, 5, 7,
      8, 9, 10, 10, 9, 11,
      12, 13, 14, 14, 13, 15,
      16, 17, 18, 18, 17, 19, 
      20,21,22,22,21,23
    ])
  }
}

```



2.åœ¨Googleæµè§ˆå™¨ä¸­æ‰“å¼€ä¼ æ„Ÿå™¨ï¼Œæ¨¡æ‹Ÿé™€èºä»ªçš„æ—‹è½¬ã€‚

ä¸€æˆ‘ä»¬åœ¨ç”µè„‘é‡Œåšæµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦ç”¨æµè§ˆå™¨é‡Œçš„å¼€å‘è€…å·¥å…·

![ä¼ æ„Ÿå™¨](images/ä¼ æ„Ÿå™¨.jpg)



ä¹‹åæˆ‘ä»¬å¯ä»¥åœ¨jsä¸­é€šè¿‡deviceorientation äº‹ä»¶ç›‘å¬é™€èºä»ªçš„å˜åŒ–ã€‚

ä»deviceorientation äº‹ä»¶çš„å›è°ƒå‚æ•°eventé‡Œï¼Œå¯ä»¥è§£æ„å‡ºalpha, beta, gamma ä¸‰ä¸ªå‚æ•°ã€‚

```js
window.addEventListener('deviceorientation', (event) => {
  const { alpha, beta, gamma }=event
})

```

alpha, beta, gammaå¯¹åº”äº†é™€èºä»ªæ¬§æ‹‰æ—‹è½¬çš„ä¸‰ä¸ªå‚æ•°ã€‚

åœ¨å³æ‰‹åæ ‡ç³»ä¸­ï¼Œå…¶æ¦‚å¿µå¦‚ä¸‹ï¼š

- alphaï¼šç»•ä¸–ç•Œåæ ‡ç³»çš„yè½´é€†æ—¶é’ˆæ—‹è½¬çš„è§’åº¦ï¼Œæ—‹è½¬èŒƒå›´æ˜¯[-180Â°,180Â°)

- betaï¼šç»•æœ¬åœ°åæ ‡ç³»çš„xè½´é€†æ—¶é’ˆæ—‹è½¬çš„è§’åº¦ï¼Œæ—‹è½¬èŒƒå›´æ˜¯[-180Â°,180Â°)

- gamma ï¼šç»•æœ¬åœ°åæ ‡ç³»çš„zè½´é¡ºæ—¶é’ˆæ—‹è½¬çš„è§’åº¦ï¼Œæ—‹è½¬èŒƒå›´æ˜¯[-90Â°,90Â°)



æ³¨ï¼šalpha, beta, gammaå…·ä½“æ˜¯ç»•å“ªä¸ªè½´æ—‹è½¬ï¼Œè·Ÿæˆ‘ä»¬å½“å‰ç¨‹åºæ‰€ä½¿ç”¨çš„åæ ‡ç³»æœ‰å…³ã€‚æ‰€ä»¥å¤§å®¶ä¹‹åè‹¥æ˜¯çœ‹åˆ°æœ‰äº›æ•™ç¨‹åœ¨è¯´é™€èºä»ªæ—¶ï¼Œè·Ÿæˆ‘è¯´çš„ä¸ä¸€æ ·ï¼Œä¹Ÿä¸è¦æƒŠå¥‡ï¼Œåªè¦åœ¨å®è·µä¸­æ²¡æœ‰é—®é¢˜å°±å¯ä»¥ã€‚

é™€èºä»ªæ¬§æ‹‰æ—‹è½¬çš„é¡ºåºæ˜¯'YXZ'ï¼Œè€Œä¸æ˜¯æ¬§æ‹‰å¯¹è±¡é»˜è®¤çš„'XYZ'ã€‚

æ¬§æ‹‰æ—‹è½¬é¡ºåºæ˜¯å¾ˆé‡è¦çš„ï¼Œå¦‚æœä¹±äº†ï¼Œå°±æ— æ³•è®©VRæ—‹è½¬ä¸é™€èºä»ªç›¸åŒ¹é…äº†ã€‚

æ¥ä¸‹æ¥ï¼ŒåŸºäºä¹‹å‰VR.html æ–‡ä»¶åšä¸‹è°ƒæ•´ã€‚



3.å»ºç«‹ç«‹æ–¹ä½“å¯¹è±¡

```js
import Box from './lv/Box.js'
const box = new Box(1, 1, 1)

```



4.è°ƒæ•´ç›¸æœºæ•°æ®

```js
// ç›®æ ‡ç‚¹
const target = new Vector3()
//è§†ç‚¹
const eye = new Vector3(0, 0.45, 0.0001)
const [fov, aspect, near, far] = [
  120, canvas.width / canvas.height,
  0.01, 2
]
// é€è§†ç›¸æœº
const camera = new PerspectiveCamera(fov, aspect, near, far)
camera.position.copy(eye)

```

ç›¸æœºçš„è§†çº¿æ˜¯æ ¹æ®é™€èºä»ªçš„åˆå§‹çŠ¶æ€è®¾ç½®çš„ã€‚

åœ¨é™€èºä»ªçš„alpha, beta, gammaçš†ä¸º0çš„æƒ…å†µä¸‹ï¼Œæ‰‹æœºæˆä¿¯è§†çŠ¶æ€ã€‚

![image-20220114152104090](images/image-20220114152104090.png)

æ‰€ä»¥ï¼Œç›¸æœºä¹Ÿè¦æˆä¿¯è§†çŠ¶æ€ï¼Œå› æ­¤è§†ç‚¹çš„yå€¼è®¾ç½®ä¸º0.45ã€‚

ç„¶è€Œï¼Œè§†çº¿ä¹Ÿä¸èƒ½å®Œå…¨å‚ç›´ï¼Œå› ä¸ºè¿™æ ·è§†ç‚¹ç»•yè½´æ—‹è½¬å°±ä¼šå¤±æ•ˆã€‚

æ‰€ä»¥ï¼Œè§†ç‚¹çš„zå€¼ç»™äº†ä¸€ä¸ªè¾ƒå°çš„æ•°å­—0.0001ã€‚



5.åœºæ™¯çš„æ¸²æŸ“å’Œä¹‹å‰æ˜¯ä¸€æ ·ã€‚

```js
// è½¨é“æ§åˆ¶å™¨
const orbit = new OrbitControls({
  camera,
  target,
  dom: canvas,
  enablePan: false,
  maxZoom: 15,
  minZoom: 0.4
})

// åœºæ™¯
const scene = new Scene({ gl })
//æ³¨å†Œç¨‹åºå¯¹è±¡
scene.registerProgram(
  'map',
  {
    program: createProgram(
      gl,
      document.getElementById('vs').innerText,
      document.getElementById('fs').innerText,
    ),
    attributeNames: ['a_Position', 'a_Pin'],
    uniformNames: ['u_PvMatrix', 'u_ModelMatrix','u_Sampler']
  }
)

//ç«‹æ–¹ä½“
const matBox = new Mat({
  program: 'map',
  data: {
    u_PvMatrix: {
      value: orbit.getPvMatrix().elements,
      type: 'uniformMatrix4fv',
    },
    u_ModelMatrix: {
      value: new Matrix4().elements,
      type: 'uniformMatrix4fv',
    },
  },
})
const geoBox = new Geo({
  data: {
    a_Position: {
      array: box.vertices,
      size: 3
    },
    a_Pin: {
      array: box.uv,
      size: 2
    }
  },
  index: {
    array: box.indexes
  }
})

//åŠ è½½å›¾ç‰‡
const image = new Image()
image.src = './images/magic.jpg'
image.onload = function () {
  matBox.maps.u_Sampler = {
    image,
    magFilte: gl.LINEAR,
    minFilter: gl.LINEAR,
  }
  scene.add(new Obj3D({
    geo: geoBox,
    mat: matBox
  }))
  render()
}

function render() {
  orbit.getPvMatrix()
  scene.draw()
  requestAnimationFrame(render)
}

```

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220114152104090](images/image-20220114152104090.png)





7.ç›‘å¬é™€èºä»ªäº‹ä»¶æ—¶ï¼Œéœ€è¦è€ƒè™‘ä¸‰ä»¶äº‹ï¼š

- åˆ¤æ–­å½“å‰è®¾å¤‡é‡Œæ˜¯å¦æœ‰é™€èºä»ªã€‚

- è®©ç”¨æˆ·è§¦å‘æµè§ˆå™¨å¯¹é™€èºä»ªäº‹ä»¶çš„ç›‘å¬ï¼Œå¯é€šè¿‡click ä¹‹ç±»çš„äº‹ä»¶è§¦å‘ã€‚
- è‹¥ç³»ç»Ÿæ˜¯iosï¼Œéœ€è¦è¯·æ±‚ç”¨æˆ·è®¸å¯ã€‚

css æ ·å¼ï¼š

```css
html {height: 100%;}
body {
  margin: 0;
  height: 100%;
  overflow: hidden
}
.wrapper {
  display: flex;
  position: absolute;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  top: 0;
  background-color: rgba(0, 0, 0, 0.4);
  z-index: 10;
}
#playBtn {
  padding: 24px 24px;
  border-radius: 24px;
  background-color: #00acec;
  text-align: center;
  color: #fff;
  cursor: pointer;
  font-size: 24px;
  font-weight: bold;
  border: 6px solid rgba(255, 255, 255, 0.7);
  box-shadow: 0 9px 9px rgba(0, 0, 0, 0.7);
}

```

html æ ‡ç­¾ï¼š

```html
<canvas id="canvas"></canvas>
<div class="wrapper">
  <div id="playBtn">å¼€å¯VRä¹‹æ—…</div>
</div>

```

js ä»£ç ï¼š

```js
// é®ç½©
const wrapper = document.querySelector('.wrapper')
// æŒ‰é’®
const btn = document.querySelector('#playBtn')
// åˆ¤æ–­è®¾å¤‡ä¸­æ˜¯å¦æœ‰é™€èºä»ª
if (window.DeviceMotionEvent) {
  // è®©ç”¨æˆ·è§¦å‘é™€èºä»ªçš„ç›‘å¬äº‹ä»¶
  btn.addEventListener('click', () => {
    //è‹¥æ˜¯iosç³»ç»Ÿï¼Œéœ€è¦è¯·æ±‚ç”¨æˆ·è®¸å¯
    if (DeviceMotionEvent.requestPermission) {
      requestPermission()
    } else {
      rotate()
    }
  })
} else {
  btn.innerHTML = 'æ‚¨çš„è®¾å¤‡é‡Œæ²¡æœ‰é™€èºä»ªï¼'
}

//è¯·æ±‚ç”¨æˆ·è®¸å¯
function requestPermission() {
  DeviceMotionEvent.requestPermission()
    .then(function (permissionState) {
    // granted:ç”¨æˆ·å…è®¸æµè§ˆå™¨ç›‘å¬é™€èºä»ªäº‹ä»¶
    if (permissionState === 'granted') {
      rotate()
    } else {
      btn.innerHTML = 'è¯·å…è®¸ä½¿ç”¨é™€èºä»ªğŸŒ¹'
    }
  }).catch(function (err) {
    btn.innerHTML = 'è¯·æ±‚å¤±è´¥ï¼'
  });
}

//ç›‘å¬é™€èºä»ª
function rotate() {
  wrapper.style.display = 'none'
  window.addEventListener('deviceorientation', ({ alpha, beta, gamma }) => {
    const rad = Math.PI / 180
    const euler = new Euler(
      beta * rad,
      alpha * rad,
      -gamma * rad,
      'YXZ'
    )
    camera.position.copy(
      eye.clone().applyEuler(euler)
    )
    orbit.updateCamera()
    orbit.resetSpherical()
  })
}

```

å…³äºé™€èºä»ªçš„åŸºæœ¬ç”¨æ³•æˆ‘ä»¬å°±è¯´åˆ°è¿™ã€‚

æˆ‘ä¹‹å‰åœ¨ç½‘ä¸Šçœ‹äº†ä¸€äº›é™€èºä»ªç›¸å…³çš„æ•™ç¨‹ï¼Œå¾ˆå¤šéƒ½æ²¡è¯´åˆ°ç‚¹ä¸Šï¼Œå› ä¸ºè‹¥æ˜¯ä¸çŸ¥é“æ¬§æ‹‰æ—‹è½¬çš„æ¦‚å¿µï¼Œå°±è¯´ä¸æ˜ç™½é™€èºä»ªã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸€å®šä¸è¦èˆä¸å¾—èŠ±æ—¶é—´å­¦ä¹ å›¾å½¢å­¦ï¼Œå›¾å½¢å­¦å…³ç³»ç€æˆ‘ä»¬è‡ªèº«å‘å±•çš„æ½œåŠ›ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åœ¨VR.html æ–‡ä»¶é‡Œï¼Œä»¥åŒæ ·çš„åŸç†æŠŠé™€èºä»ªå†™è¿›å»ï¼Œå¹¶ç»“åˆé¡¹ç›®çš„å®é™…éœ€æ±‚åšä¸€ä¸‹ä¼˜åŒ–ã€‚



#### 2-4-VR+é™€èºä»ª

æˆ‘ä»¬å¯ä»¥å…ˆæŠŠé™€èºä»ªå°è£…ä¸€ä¸‹ï¼Œä»¥åç”¨èµ·æ¥æ–¹ä¾¿ã€‚

1.å°è£…ä¸€ä¸ªé™€èºä»ªå¯¹è±¡Gyro.js

```js
import {Euler} from 'https://unpkg.com/three/build/three.module.js';

const rad = Math.PI / 180

const defAttr = () => ({
  //ç”¨äºè§¦å‘äº‹ä»¶çš„æŒ‰é’®
  btn: null,
  //æ²¡æœ‰é™€èºä»ª
  noDevice: () => { },
  //å½“ç‚¹å‡»æŒ‰é’®æ—¶
  onClick: () => { },
  //å¯ä»¥ä½¿ç”¨é™€èºä»ªæ—¶è§¦å‘ä¸€æ¬¡
  init: () => { },
  //ç”¨æˆ·æ‹’ç»å¼€å¯é™€èºä»ª
  reject: () => { },
  //è¯·æ±‚å¤±è´¥
  error: () => { },
  //é™€èºä»ªå˜æ¢
  change: () => { },
})

export default class Gyro {
  constructor(attr) {
    Object.assign(this, defAttr(), attr)
  }
  start() {
    const { btn } = this
    if (window.DeviceMotionEvent) {
      // è®©ç”¨æˆ·è§¦å‘é™€èºä»ªçš„ç›‘å¬äº‹ä»¶
      btn.addEventListener('click', () => {
        this.onClick()
        //è‹¥ç³»ç»Ÿæ˜¯iosï¼Œéœ€è¦è¯·æ±‚ç”¨æˆ·è®¸å¯
        if (DeviceMotionEvent.requestPermission) {
          this.requestPermission()
        } else {
          this.translate()
        }
      })
    } else {
      this.noDevice()
    }
  }
  //è¯·æ±‚ç”¨æˆ·è®¸å¯
  requestPermission() {
    DeviceMotionEvent.requestPermission()
      .then((permissionState) => {
      // granted:ç”¨æˆ·å…è®¸æµè§ˆå™¨ç›‘å¬é™€èºä»ªäº‹ä»¶
      if (permissionState === 'granted') {
        this.translate()
      } else {
        this.reject()
      }
    }).catch((err) => {
      this.error(err)
    });
  }
  // ç›‘å¬é™€èºä»ª
  translate() {
    this.init()
    window.addEventListener('deviceorientation', ({ beta, alpha, gamma }) => {
      this.change(new Euler(
        beta * rad,
        alpha * rad,
        -gamma * rad,
        'YXZ'
      ))
    })
  }
}

```



2.æŠŠé™€èºä»ªå¯¹è±¡å¼•å…¥VRæ–‡ä»¶

```js
import Gyro from './lv/Gyro.js'

// é®ç½©
const wrapper = document.querySelector('.wrapper')
// æŒ‰é’®
const btn = document.querySelector('#playBtn')
// é™€èºä»ª
const gyro = new Gyro({
  btn,
  noDevice: () => {
    btn.innerHTML = 'æ‚¨çš„è®¾å¤‡é‡Œæ²¡æœ‰é™€èºä»ªï¼'
  },
  reject: () => {
    btn.innerHTML = 'è¯·å…è®¸ä½¿ç”¨é™€èºä»ªğŸŒ¹'
  },
  error: () => {
    btn.innerHTML = 'è¯·æ±‚å¤±è´¥ï¼'
  },
  init: () => {
    wrapper.style.display = 'none'
  },
  change: (euler) => {
    camera.position.copy(
      eye.clone().applyEuler(euler)
    )
    orbit.updateCamera()
    orbit.resetSpherical()
  }
})
gyro.start()

```



3.ä¼˜åŒ–å›¾åƒçš„åŠ è½½ã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸ºäº†è®©ç”¨æˆ·çœ‹åˆ°æ¯”è¾ƒæ¸…æ™°çš„æ•ˆæœï¼Œå¾€å¾€éœ€è¦ä½¿ç”¨æ¯”è¾ƒå¤§çš„å…¨æ™¯å›¾ï¼Œæ¯”å¦‚4096*2048 çš„å°ºå¯¸ã€‚

å¤§å°ºå¯¸çš„å›¾ç‰‡åŠ è½½èµ·æ¥ä¼šå¾ˆæ…¢ï¼Œä¸ºäº†å‡å°‘ç”¨æˆ·çš„ç­‰å¾…ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåŠ è½½ä¸€ä¸ªè¾ƒå°çš„å›¾ç‰‡ï¼Œç„¶åæ…¢æ…¢çš„è¿‡åº¦åˆ°å¤§å›¾ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»å°åˆ°å¤§å‡†å¤‡4å¼ ä¸åŒå°ºå¯¸çš„å…¨æ™¯å›¾ï¼š

- 512*256
- 1024*512
- 2048*1024
- 4096*2048

æ¥ä¸‹æ¥å…ˆåŠ è½½ç¬¬ä¸€å¼ å°å›¾ï¼Œå°†å…¶æ˜¾ç¤ºå‡ºæ¥åï¼Œå†ä¾æ¬¡åŠ è½½åé¢çš„å¤§å›¾ã€‚

```js
//å›¾ç‰‡åºå·
let level = 0
//åŠ è½½å›¾ç‰‡
loadImg()
function loadImg() {
  const image = new Image()
  image.src = `./images/room${level}.jpg`
  image.onload = function () {
    if (level === 0) {
      firstRender(image)
    } else {
      //æ›´æ–°è´´å›¾
      matEarth.setMap('u_Sampler', { image })
    }
    if (level < 3) {
      level++
      loadImg()
    }
  }
}
// ç¬¬ä¸€æ¬¡æ¸²æŸ“
function firstRender(image) {
  btn.innerHTML = 'å¼€å¯VRä¹‹æ—…'
  matEarth.maps.u_Sampler = {
    image,
    magFilte: gl.LINEAR,
    minFilter: gl.LINEAR,
  }
  scene.add(new Obj3D({
    geo: geoEarth,
    mat: matEarth
  }))
  render()
}

```

ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¾—å¾®è°ƒä¸€ä¸‹Mat.jsé‡Œçš„æ›´æ–°è´´å›¾æ–¹æ³•ï¼š

```js
updateMap(gl,map,ind) {
  â€¦â€¦
  //gl.bindTexture(gl.TEXTURE_2D, null)
}

```

æˆ‘ä»¬éœ€è¦å–æ¶ˆå¯¹çº¹ç†ç¼“å†²åŒºçš„æ¸…ç†ã€‚

ä»¥å‰æˆ‘ä»¬è¦æ¸…ç†çº¹ç†ç¼“å†²åŒºï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å¯¹çº¹ç†ç¼“å†²åŒºé‡Œçš„çº¹ç†å¯¹è±¡è¿›è¡Œæ›´æ–°ï¼Œå°†å…¶æ¸…ç†æ‰è¿˜å¯ä»¥èŠ‚çº¦å†…å­˜ã€‚

è€Œç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹çº¹ç†ç¼“å†²åŒºé‡Œçš„çº¹ç†å¯¹è±¡è¿›è¡Œæ›´æ–°ï¼Œé‚£å°±ä¸èƒ½æ¸…ç†æ‰äº†ã€‚



#### 2-5-å¼€åœºåŠ¨ç”»

å¼€åœºåŠ¨ç”»çš„ä½œç”¨ï¼Œå°±æ˜¯ç»™ç”¨æˆ·ä¸€ä¸ªå¸å¼•çœ¼çƒçš„æ•ˆæœï¼Œæé«˜é¡¹ç›®çš„è¶£å‘³æ€§ã€‚

å¼€åœºåŠ¨ç”»çš„å¼€åœºæ–¹å¼æœ‰å¾ˆå¤šï¼Œå’±ä»¬è¿™é‡Œå°±è¯´ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„ï¼šä»ä¸Šå¸è§†è§’åˆ°æ™®é€šè§†è§’çš„è¿‡åº¦ã€‚

ä¸Šå¸è§†è§’å°±æ˜¯ä¸€ä¸ªä¿¯è§†çš„è§†è§’ï¼Œè§†é‡ä¸€å®šè¦å¹¿ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20220107220745375](images/image-20220107220745375.png)



ä¹‹åï¼Œæˆ‘ä¼šç”¨è¡¥é—´åŠ¨ç”»ï¼Œå°†å…¶è¿‡åº¦åˆ°æ™®é€šè§†è§’ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20220107131904449](images/image-20220107131904449.png)

ä»ä¸Šå¸è§†è§’åˆ°æ™®é€šè§†è§’çš„å˜æ¢æ¶‰åŠä»¥ä¸‹å±æ€§ï¼š

- ç›¸æœºè§†ç‚¹çš„ä½ç½®
- ç›¸æœºè§†æ¤ä½“çš„å‚ç›´è§†è§’

æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿å¯ä»¥åŸºäºä¸Šé¢çš„å±æ€§åšç¼“åŠ¨åŠ¨ç”»ã€‚

1.æŠŠå½“å‰çš„ç›¸æœºè§†è§’è°ƒä¸ºä¸Šå¸è§†è§’ã€‚

```js
// ç›®æ ‡ç‚¹
const target = new Vector3()
//è§†ç‚¹-æ ¹æ®é™€èºä»ªåšæ¬§æ‹‰æ—‹è½¬
const eye = new Vector3( 0.15,0, 0.0001)
// é€è§†ç›¸æœº
const [fov, aspect, near, far] = [
  130, canvas.width / canvas.height,
  0.01, 2
]
const camera = new PerspectiveCamera(fov, aspect, near, far)
// ä¸Šå¸è§†è§’
camera.position.set(0, 0.42, 0)
```



2.åŸºäºç›¸æœºçš„è§†ç‚¹å’Œè§†æ¤ä½“çš„å‚ç›´å¤¹è§’å»ºç«‹ä¸¤ä¸ªç›®æ ‡å˜é‡

```js
const endPos = camera.position.clone()
let endFov = fov
```

ä¸Šé¢çš„ä¸¤ä¸ªç›®æ ‡å˜é‡é»˜è®¤æ˜¯å’Œå½“å‰ç›¸æœºä¸€è‡´çš„ï¼Œä¹‹åé™€èºä»ªå‘ç”Ÿå˜åŒ–æ—¶ä¼šå¯¹å…¶åšä¿®æ”¹ã€‚



3.åœ¨é™€èºä»ªå‘ç”Ÿå˜åŒ–æ—¶ï¼Œè®¾ç½®ç›®æ ‡å˜é‡

```js
// é™€èºä»ª
const gyro = new Gyro({
  â€¦â€¦
  change: (euler) => {
    endFov = 60
    endPos.copy(
      eye.clone().applyEuler(euler)
    )
  }
})
```

å½“å‰çš„å¼€åœºåŠ¨ç”»æ˜¯é’ˆå¯¹æœ‰é™€èºä»ªçš„æ‰‹æœºè€Œè¨€çš„ï¼Œæ¥ä¸‹æ¥å†åšå¯¹PCç«¯çš„å¼€åœºåŠ¨ç”»ã€‚



4.å½“é¼ æ ‡ç‚¹å‡»â€œå¼€å¯VRä¹‹æ—…â€ çš„æ—¶å€™ï¼Œè‹¥æµè§ˆå™¨åœ¨PCç«¯ï¼Œå°†è§†è§’è°ƒä¸ºæ™®é€šè§†è§’ã€‚

```js
const pc = isPC()
const gyro = new Gyro({
 	â€¦â€¦
  onClick: () => {
    if (pc) {
      endPos.set(0.15, 0, 0.0001)
      endFov = 60
    }
  }
})
```

isPC() æ˜¯åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦åœ¨PCç«¯çš„æ–¹æ³•ã€‚

```js
const isPC=()=>!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)

```



5.å»ºç«‹ç¼“åŠ¨åŠ¨ç”»æ–¹æ³•

```js
function tween(ratio = 0.05) {
  //è‹¥å½“å‰è®¾å¤‡ä¸ºPC,ç¼“åŠ¨ç»“æŸåå°±ä¸å†ç¼“åŠ¨ï¼Œä¹‹åçš„å˜æ¢äº¤ç»™è½¨é“æ§åˆ¶å™¨
  if (pc && camera.fov < endFov + 1) { return }

  camera.position.lerp(endPos, ratio)
  camera.fov += (endFov - camera.fov) * ratio
  camera.updateProjectionMatrix()
  orbit.updateCamera()
  orbit.resetSpherical()
}
```

- camera.updateProjectionMatrix() æ›´æ–°æŠ•å½±çŸ©é˜µã€‚

  å› ä¸ºä¸Šé¢æ›´æ–°äº†è§†æ¤ä½“çš„å‚ç›´å¤¹è§’ï¼Œæ‰€ä»¥ç›¸æœºçš„æŠ•å½±çŸ©é˜µä¹Ÿè¦åšåŒæ­¥çš„æ›´æ–°ï¼Œå…·ä½“åŸç†å‚è§ä¹‹å‰çš„é€è§†æŠ•å½±çŸ©é˜µã€‚

- orbit.updateCamera() æ›´æ–°ç›¸æœºï¼Œå°†ç›¸æœºçš„è§†ç‚¹ä½ç½®å’Œè§†çº¿å†™å…¥ç›¸æœºçš„æœ¬åœ°çŸ©é˜µé‡Œã€‚

- orbit.resetSpherical() é‡ç½®çƒåæ ‡ã€‚ç”¨é¼ æ ‡æ—‹è½¬ç›¸æœºçš„æ—¶å€™ä¼šå°†æ—‹è½¬ä¿¡æ¯å†™å…¥çƒåæ ‡ã€‚



6.åœ¨è¿ç»­æ¸²æŸ“æ—¶æ‰§è¡Œç¼“åŠ¨åŠ¨ç”»

```js
function render() {
  tween()
  orbit.getPvMatrix()
  scene.draw()
  requestAnimationFrame(render)
}
```





#### 2-6-æ·»åŠ æ ‡è®°ç‚¹

æ ‡è®°ç‚¹å¯ä»¥å‘Šè¯‰ç”¨æˆ·ä¸åŒåŒºåŸŸçš„åç§°ï¼Œæˆ–è€…ä¸ºç”¨æˆ·æŒ‡å¼•æ–¹å‘ã€‚

åœ¨æ·»åŠ æ ‡è®°ç‚¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦è€ƒè™‘ä¸¤ç‚¹ï¼š

- å¦‚ä½•æ·»åŠ æ ‡è®°ç‚¹
- å¦‚ä½•åˆ¶ä½œæ ‡è®°ç‚¹

æ¥ä¸‹æ¥æˆ‘ä¼šåœ¨VR åœºæ™¯ä¸­æ·»åŠ HTMLç±»å‹çš„æ ‡è®°ç‚¹ï¼Œè¿™ç§æ–¹æ³•æ˜¯æ¯”è¾ƒå¸¸è§çš„ã€‚

åœ¨VRä¸­æ·»åŠ HTMLç±»å‹æ ‡è®°ç‚¹çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šå¦‚ä½•è®©HTML æ ‡è®°ç‚¹éšVR åœºæ™¯åŒæ­¥å˜æ¢ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜è¦æŒ‰ä»¥ä¸‹å‡ æ­¥èµ°ï¼š

![image-20220129161308872](images/image-20220129161308872.png)

1.é¼ æ ‡ç‚¹å‡»canvas ç”»å¸ƒæ—¶ï¼Œå°†æ­¤ç‚¹çš„canvasåæ ‡è½¬ä¸–ç•Œåæ ‡Aã€‚

â€‹	æ³¨ï¼šcanvasåæ ‡è½¬ä¸–ç•Œåæ ‡çš„åŸç†åœ¨â€œè¿›å…¥ä¸‰ç»´ä¸–ç•Œâ€çš„é€‰æ‹©ç«‹æ–¹ä½“é‡Œè¯´è¿‡ã€‚

2.ä»¥è§†ç‚¹ä¸ºèµ·ç‚¹ï¼ŒAç‚¹ä½æ–¹å‘åšå°„çº¿EAã€‚

3.æ±‚å°„çº¿EAä¸çƒä½“çš„äº¤ç‚¹Pï¼Œæ­¤ç‚¹ä¾¿æ˜¯æ ‡è®°ç‚¹åœ¨ä¸–ç•Œåæ ‡ç³»å†…çš„ä¸–ç•Œåæ ‡ã€‚

4.åœ¨å˜æ¢VRåœºæ™¯æ—¶ï¼Œå°†æ ‡è®°ç‚¹çš„ä¸–ç•Œåæ ‡è½¬canvasåæ ‡ï¼Œç„¶åç”¨æ­¤åæ ‡æ›´æ–°æ ‡è®°ç‚¹çš„ä½ç½®ã€‚

åœ¨ä¸Šé¢çš„æ­¥éª¤ä¸­ï¼Œç¬¬3æ­¥æ˜¯å…³é”®ï¼Œæˆ‘ä»¬è¯¦ç»†è®²è§£ä»¥ä¸‹ã€‚

å·²çŸ¥ï¼š

- å°„çº¿ EA
- çƒä½“çƒå¿ƒä¸ºOï¼ŒåŠå¾„ä¸º r

æ±‚ï¼šå°„çº¿ EAä¸çƒä½“çš„äº¤ç‚¹P

è§£ï¼š

å…ˆåˆ¤æ–­å°„çº¿çš„åŸºçº¿ä¸çƒä½“çš„å…³ç³»ã€‚

è®¾ï¼šEAçš„å•ä½å‘é‡ä¸ºv

ç”¨EOå‰ä¹˜EAçš„å•ä½å‘é‡ï¼Œæ±‚å¾—çƒå¿ƒO åˆ°ç›´çº¿çš„è·ç¦»|OB|

```js
|OB|=|EO^v|
```

åŸºäº|OB|å’ŒåŠå¾„rï¼Œå¯ä»¥çŸ¥é“åŸºçº¿ä¸çƒä½“çš„å…³ç³»ï¼š

![image-20220129172220487](images/image-20220129172220487.png)

- |OB|>rï¼Œç›´çº¿ä¸çƒä½“ç›¸ç¦»ï¼Œæ²¡æœ‰äº¤ç‚¹
- |OB|=rï¼Œç›´çº¿ä¸çƒä½“ç›¸åˆ‡ï¼Œ1ä¸ªäº¤ç‚¹ ï¼Œäº¤ç‚¹ä¸ºBç‚¹

```js
B=v*(EOÂ·v)

```

- |OB|<rï¼Œç›´çº¿ä¸çƒä½“ç›¸äº¤ï¼Œ2ä¸ªäº¤ç‚¹ï¼Œå…¶ç®—æ³•å¦‚ä¸‹ï¼š

![image-20220129161308872](images/image-20220129161308872.png)

åœ¨ç›´çº¿EAä¸Šçš„ç‚¹å¯ä»¥å†™åšï¼š

```js
E+Î»v, Î»âˆˆR

```

ç›´çº¿å’Œçƒä½“ç›¸äº¤çš„ç‚¹æ»¡è¶³ï¼š

```js
(E+Î»v-O)Â²=rÂ²

```

(Î»v+OE)Â²å¯ç†è§£ä¸ºå‘é‡OPçš„é•¿åº¦çš„å¹³æ–¹ã€‚

E-Oå¯å†™åšOEï¼š

```js
(Î»v+OE)Â²=rÂ²

```

å±•å¼€ä¸Šå¼ï¼š

```js
Î»Â²vÂ²+2Î»vÂ·OE+OEÂ²=rÂ²

```

å› ä¸ºï¼šå•ä½å‘é‡ä¸å…¶è‡ªèº«çš„ç‚¹ç§¯ç­‰äº1

æ‰€ä»¥ï¼š

```js
Î»Â²+2Î»vÂ·OE+OEÂ²=rÂ²
Î»Â²+2Î»vÂ·OE+OEÂ²-rÂ²=0

```

è§£ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼ï¼Œæ±‚Î»ï¼š

ä¸ºäº†æ–¹ä¾¿ä¹¦å†™ï¼Œè®¾ï¼š

```js
b=2vÂ·OE
c=OEÂ²-rÂ²

```

åˆ™ï¼š

```js
Î»Â²+Î»b+c=0
Î»Â²+bÎ»+(b/2)Â²=-c+(b/2)Â²
(Î»+b/2)Â²=(bÂ²-4c)/4
Î»+b/2=Â±sqrt(bÂ²-4c)/2
Î»=(-bÂ±sqrt(bÂ²-4c))/2

```

çŸ¥é“äº†Î» ï¼Œä¹Ÿå°±å¯ä»¥ç›´çº¿ä¸çƒä½“çš„äº¤ç‚¹ã€‚

```
Î»v+OE

```

æ³¨ï¼šå½“Î»å°äº0æ—¶ï¼Œäº¤ç‚¹åœ¨å°„çº¿EAçš„åæ–¹å‘ï¼Œåº”è¯¥èˆå¼ƒã€‚

å…³äºå°„çº¿ä¸çƒä½“çš„äº¤ç‚¹ï¼Œå’±ä»¬å°±è¯´åˆ°è¿™ã€‚

æ¥ä¸‹æ¥å’±ä»¬åŸºäºä¹‹å‰çš„VR.html ä»£ç ï¼Œåœ¨VRçƒä½“ä¸Šæ‰“ä¸€ä¸ªæ ‡è®°ç‚¹ã€‚

1.å»ºç«‹ä¸€ä¸ªæ ‡è®°ç‚¹ã€‚å½“å‰å…ˆä¸è€ƒè™‘æ ‡è®°ç‚¹çš„æ–‡å­—å†…å®¹çš„ç¼–è¾‘ï¼Œåªå…³æ³¨æ ‡è®°ç‚¹çš„ä½ç½®ã€‚

```html
<style>
  #mark {
    position: absolute;
    top: 0;
    left: 0;
    color: #fff;
    background-color: rgba(0, 0, 0, 0.6);
    padding: 6px 12px;
    border-radius: 3px;
    user-select: none;
  }
</style>

<div id="mark">æ ‡è®°ç‚¹</div>

```



2.è·å–æ ‡è®°ç‚¹ï¼Œå»ºç«‹markWpå˜é‡ï¼Œç”¨äºè®°å½•æ ‡è®°ç‚¹çš„ä¸–ç•Œåæ ‡ã€‚

```js
// æ ‡è®°
const mark = document.querySelector('#mark')
// æ ‡è®°ç‚¹çš„ä¸–ç•Œä½
let markWp = null

```



3.å½“é¼ æ ‡åŒå‡»canvas ç”»å¸ƒçš„æ—¶å€™ï¼Œæ·»åŠ æ ‡è®°ç‚¹ã€‚

```js
canvas.addEventListener('dblclick', event => {
  addMark(event)
})

```

addMark() æ–¹æ³•åšäº†3ä»¶äº‹æƒ…ï¼š

- worldPos() æŠŠé¼ æ ‡ç‚¹å‡»åœ¨canvasç”»å¸ƒä¸Šçš„canvasåæ ‡è½¬æ¢ä¸ºä¸–ç•Œåæ ‡.

  æ­¤æ–¹æ³•å’±ä»¬ä¹‹å‰å†™è¿‡ï¼Œä»Utils.js ä¸­å¼•å…¥å³å¯ã€‚

- getMarkWp() æ ¹æ®é¼ æ ‡ç‚¹çš„ä¸–ç•Œåæ ‡è®¾ç½®æ ‡è®°ç‚¹çš„ä¸–ç•Œåæ ‡ã€‚

  è¿™ä¾¿æ˜¯å‚ç…§ä¹‹å‰å°„çº¿å’Œçƒä½“äº¤ç‚¹çš„æ•°å­¦å…¬å¼æ¥å†™çš„ã€‚

  æ³¨ï¼šé¼ æ ‡ç‚¹çš„ä¸–ç•Œåæ ‡å¹¶ä¸æ˜¯æ ‡è®°ç‚¹çš„ä¸–ç•Œåæ ‡ã€‚

- setMarkCp() è®¾ç½®æ ‡è®°ç‚¹çš„canvasåæ ‡ä½ã€‚

```js
function addMark(event) {
  //é¼ æ ‡ç‚¹çš„ä¸–ç•Œåæ ‡
  const A = worldPos(event, canvas, pvMatrix)
  //è·å–æ ‡è®°ç‚¹çš„ä¸–ç•Œåæ ‡
  markWp =getMarkWp(camera.position, A, target, earth.r)
  //è®¾ç½®æ ‡è®°ç‚¹çš„canvasåæ ‡ä½
  setMarkCp(event.clientX, event.clientY)
}

/* è·å–å°„çº¿å’Œçƒä½“çš„äº¤ç‚¹
  E å°„çº¿èµ·ç‚¹-è§†ç‚¹
  A å°„çº¿ç›®æ ‡ç‚¹
  O çƒå¿ƒ
  r åŠå¾„
*/
function getMarkWp(E, A, O, r) {
  const v = A.clone().sub(E).normalize()
  const OE = E.clone().sub(O)
  //b=2vÂ·OE
  const b = v.clone().multiplyScalar(2).dot(OE)
  //c=OEÂ²-rÂ²
  const c = OE.clone().dot(OE) - r * r
  //Î»=(-bÂ±sqrt(bÂ²-4c))/2
  const lambda = (-b + Math.sqrt(b * b - 4 * c)) / 2
  //Î»v+OE
  return v.clone().multiplyScalar(lambda).add(OE)
}

//è®¾ç½®æ ‡è®°ç‚¹çš„canvasåæ ‡ä½
function setMarkCp(x, y) {
  mark.style.left = `${x}px`
  mark.style.top = `${y}px`
}

```



4.å½“æ—‹è½¬å’Œç¼©æ”¾ç›¸æœºçš„æ—¶å€™ï¼Œå¯¹æ ‡è®°ç‚¹è¿›è¡ŒåŒæ­¥å˜æ¢ã€‚

```js
canvas.addEventListener('pointermove', event => {
  orbit.pointermove(event)
  updateMarkCp()
})
canvas.addEventListener('wheel', event => {
  orbit.wheel(event, 'OrthographicCamera')
  updateMarkCp()
})

//æ›´æ–°æ ‡è®°ç‚¹çš„ä½ç½®
function updateMarkCp() {
  if (!markWp) { return }

  //åˆ¤æ–­æ ‡è®°ç‚¹åœ¨ç›¸æœºçš„æ­£é¢è¿˜æ˜¯èƒŒé¢
  const {position}=camera
  const dot = markWp.clone().sub(position).dot(
    target.clone().sub(position)
  )
  if (dot > 0) {
    mark.style.display = 'block'
  } else {
    mark.style.display = 'none'
  }

  // å°†æ ‡è®°ç‚¹çš„ä¸–ç•Œåæ ‡è½¬è£å‰ªåæ ‡
  const { x, y } = markWp.clone().applyMatrix4(pvMatrix)
  // å°†æ ‡è®°ç‚¹çš„è£å‰ªåæ ‡è½¬canvasåæ ‡
  setMarkCp(
    (x + 1) * canvas.width / 2,
    (-y + 1) * canvas.height / 2
  )
}

```

ä¹‹åå›´ç»•æ ‡è®°ç‚¹è¿˜å¯ä»¥å†è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

- ä½¿æ ‡è®°ç‚¹çš„æ–‡å­—å†…å®¹å¯ç¼–è¾‘
- ä¼˜åŒ–æ ‡è®°ç‚¹æ ·å¼
- ä½¿æ ‡è®°ç‚¹å¯æ‹–æ‹½
- æ·»åŠ å¤šä¸ªæ ‡è®°ç‚¹
- â€¦â€¦

è¿™äº›éƒ½æ˜¯æ­£å¸¸çš„å‰ç«¯ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘è¿™é‡Œå°±åªé‡ç‚¹è¯´å›¾å½¢å­¦ç›¸å…³çš„çŸ¥è¯†äº†ã€‚

ä¹‹åå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸ªå«â€œ[720äº‘](https://720yun.com/)â€çš„ç½‘ç«™ï¼Œå®ƒå°±æ˜¯ä¸“ä¸šåšVRçš„ã€‚

![image-20220201151724511](images/image-20220201151724511.png)



#### 2-7-VR åœºæ™¯çš„åˆ‡æ¢

åœ¨å®é™…å¼€å‘ä¸­æˆ‘ä»¬é€šå¸¸ä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼š

åœ¨å®¢å…çš„VRåœºæ™¯ä¸­æœ‰ä¸€æ‰‡è¿›å…¥å§å®¤çš„é—¨ï¼Œåœ¨å§å®¤é—¨ä¸Šæœ‰ä¸€ä¸ªå†™ç€â€œå§å®¤â€çš„æ ‡è®°ç‚¹ã€‚

å½“æˆ‘ä»¬ç‚¹å‡»â€œå§å®¤â€æ ‡è®°ç‚¹æ—¶ï¼Œå°±è¿›å…¥å§å®¤çš„VR ä¸­ã€‚

è¿™ä¸ªéœ€æ±‚ä¾¿æ¶‰åŠäº†å®¢å…å’Œå§å®¤ä¸¤ä¸ªVRåœºæ™¯çš„åˆ‡æ¢ã€‚

ä¸¤ä¸ªVRåœºæ™¯çš„åˆ‡æ¢æœ€ç®€å•çš„å®ç°æ–¹æ³•å°±æ˜¯ç›´æ¥æ¢è´´å›¾äº†ï¼Œè¿™ä¸ªæ–¹æ³•å¿«é€Ÿã€ç®€å•ã€ç›´æ¥ï¼Œæ‰€ä»¥å’±ä»¬å…ˆç”¨ä»£ç å†™ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ã€‚

1.å‡†å¤‡ä¸€ä»½VRæ•°æ®ï¼Œæˆ‘æŠŠå®ƒæ”¾è¿›äº†vr.json æ–‡ä»¶é‡Œï¼Œè¿™å°±ç›¸å½“äºåç«¯æ•°æ®åº“é‡Œçš„æ•°æ®äº†ã€‚

```json
[
  {
    "id": 1,
    "imgSrc": "./images/room.jpg",
    "eye": [-0.14966274559865525, -0.009630159419482085, 0.002884893313037499],
    "marks": [
      {
        "name": "æ¬¡å§",
        "pos": [-0.45099085840209097, 0.0889607157340315, 0.19670596506927274],
        "link": 2
      },
      {
        "name": "ä¸»å§",
        "pos": [-0.34961792927865026, 0.30943492493218633, -0.17893387258739163],
        "link": 3
      }
    ]
  },
  {
    "id": 2,
    "imgSrc": "./images/secBed.jpg",
    "eye": [-0.14966274559865525, -0.009630159419482085, 0.002884893313037499],
    "marks": [
      {
        "name": "å®¢å…",
        "pos": [-0.34819482247111166, 0.29666506812630905, -0.20186679508508473],
        "link": 1
      }
    ]
  },
  {
    "id": 3,
    "imgSrc": "./images/mainBed.jpg",
    "eye": [-0.14966274559865525, -0.009630159419482085, 0.002884893313037499],
    "marks": [
      {
        "name": "å®¢å…",
        "pos": [-0.07077938553590507, 0.14593627464082626, -0.47296181910077806],
        "link": 1
      }
    ]
  }
]

```

å½“å‰è¿™ä¸ªjson æ–‡ä»¶é‡Œæœ‰3ä¸ªVR åœºæ™¯çš„æ•°æ®ï¼Œåˆ†åˆ«æ˜¯å®¢å…ã€ä¸»å§ã€æ¬¡å§ã€‚

- imgSrc VRå›¾ç‰‡
- eye ç›¸æœºè§†ç‚¹
- marks æ ‡è®°ç‚¹
  - name æ ‡è®°ç‚¹åç§°
  - pos æ ‡è®°ç‚¹ä¸–ç•Œä½ï¼Œå¯åœ¨ä¸Šä¸€èŠ‚æ·»åŠ æ ‡è®°ç‚¹çš„æ—¶å€™ï¼Œå°†å…¶å­˜å‚¨åˆ°åç«¯
  - link å½“å‰æ ‡è®°ç‚¹é“¾æ¥çš„VR çš„id



2.åŸºäºä¹‹å‰æ·»åŠ æ ‡è®°ç‚¹æ–‡ä»¶ï¼Œåšä¸‹è°ƒæ•´ï¼Œå»ºç«‹ä¸€ä¸ªæ ‡è®°ç‚¹å®¹å™¨marksï¼Œä¹‹åä¼šå¾€marksé‡Œæ”¾htmlç±»å‹çš„æ ‡è®°ç‚¹ã€‚

```html
<style>
  .mark {
    position: absolute;
    transform: translate(-50%, -50%);
    top: 0;
    left: 0;
    color: #fff;
    background-color: rgba(0, 0, 0, 0.6);
    padding: 6px 12px;
    border-radius: 3px;
    user-select: none;
    cursor: pointer;
  }
</style>

<body>
  <canvas id="canvas"></canvas>
  <div id="marks"></div>
  â€¦â€¦
</body>


```



3.ç®€åŒ–å‡ºä¸€ä¸ªVRåœºæ™¯ã€‚

```js
import { createProgram, worldPos } from "/jsm/Utils.js";
import {
  Matrix4, PerspectiveCamera, Vector3
} from 'https://unpkg.com/three/build/three.module.js';
import OrbitControls from './lv/OrbitControls.js'
import Mat from './lv/Mat.js'
import Geo from './lv/Geo.js'
import Obj3D from './lv/Obj3D.js'
import Scene from './lv/Scene.js'
import Earth from './lv/Earth.js'

const canvas = document.getElementById('canvas');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let gl = canvas.getContext('webgl');

// çƒä½“
const earth = new Earth(0.5, 64, 32)

// ç›®æ ‡ç‚¹
const target = new Vector3()
const [fov, aspect, near, far] = [
  60, canvas.width / canvas.height,
  0.1, 5
]
// é€è§†ç›¸æœº
const camera = new PerspectiveCamera(fov, aspect, near, far)
// è½¨é“æ§åˆ¶å™¨
const orbit = new OrbitControls({
  camera,
  target,
  dom: canvas,
  enablePan: false,
  maxZoom: 15,
  minZoom: 0.4
})

//æŠ•å½±è§†å›¾çŸ©é˜µ
const pvMatrix = orbit.getPvMatrix()

//æ ‡è®°
const marks = document.querySelector('#marks')

// åœºæ™¯
const scene = new Scene({ gl })
//æ³¨å†Œç¨‹åºå¯¹è±¡
scene.registerProgram(
  'map',
  {
    program: createProgram(
      gl,
      document.getElementById('vs').innerText,
      document.getElementById('fs').innerText,
    ),
    attributeNames: ['a_Position', 'a_Pin'],
    uniformNames: ['u_PvMatrix', 'u_ModelMatrix', 'u_Sampler']
  }
)

//çƒä½“
const mat = new Mat({
  program: 'map',
  data: {
    u_PvMatrix: {
      value: orbit.getPvMatrix().elements,
      type: 'uniformMatrix4fv',
    },
    u_ModelMatrix: {
      value: new Matrix4().elements,
      type: 'uniformMatrix4fv',
    },
  },
  maps: {
    u_Sampler: {
      magFilter: gl.LINEAR,
      minFilter: gl.LINEAR,
    }
  }
})
const geo = new Geo({
  data: {
    a_Position: {
      array: earth.vertices,
      size: 3
    },
    a_Pin: {
      array: earth.uv,
      size: 2
    }
  },
  index: {
    array: earth.indexes
  }
})
scene.add(new Obj3D({ geo, mat }))

// æ¸²æŸ“
render()

function render() {
  orbit.getPvMatrix()
  scene.draw()
  requestAnimationFrame(render)
}

/* å–æ¶ˆå³å‡»èœå•çš„æ˜¾ç¤º */
canvas.addEventListener('contextmenu', event => {
  event.preventDefault()
})
/* æŒ‡é’ˆæŒ‰ä¸‹æ—¶ï¼Œè®¾ç½®æ‹–æ‹½èµ·å§‹ä½ï¼Œè·å–è½¨é“æ§åˆ¶å™¨çŠ¶æ€ã€‚ */
canvas.addEventListener('pointerdown', event => {
  orbit.pointerdown(event)
})
/* æŒ‡é’ˆç§»åŠ¨æ—¶ï¼Œè‹¥æ§åˆ¶å™¨å¤„äºå¹³ç§»çŠ¶æ€ï¼Œå¹³ç§»ç›¸æœºï¼›è‹¥æ§åˆ¶å™¨å¤„äºæ—‹è½¬çŠ¶æ€ï¼Œæ—‹è½¬ç›¸æœºã€‚ */
canvas.addEventListener('pointermove', event => {
  orbit.pointermove(event)
  updateMarkCp()
})
/* æŒ‡é’ˆæŠ¬èµ· */
canvas.addEventListener('pointerup', event => {
  orbit.pointerup(event)
})
/* æ»šè½®äº‹ä»¶ */
canvas.addEventListener('wheel', event => {
  orbit.wheel(event, 'OrthographicCamera')
  updateMarkCp()
})


```

å½“å‰æ˜¯æ¸²æŸ“ä¸å‡ºä¸œè¥¿æ¥çš„ï¼Œå› ä¸ºæˆ‘è¿˜æ²¡æœ‰ç»™çƒä½“æŒ‡å®šè´´å›¾ã€‚



3.è¯·æ±‚VR æ•°æ®ï¼Œæ›´æ–°VRã€‚

```js
let data;
let curVr;
fetch('./data/vr.json')
  .then((res) => res.json())
  .then(dt => {
    data = dt
    curVr = getVrById(1)
    //æ›´æ–°VR
    updateVr()
    // æ¸²æŸ“
    render()
  });

//æ ¹æ®idè·å–VRæ•°æ®
function getVrById(id) {
  for (let i = 0; i < data.length; i++) {
    if (id === data[i].id) {
      return data[i]
    }
  }
}

//æ ¹æ®æ•°æ®æ›´æ–°VR
function updateVr() {
  const image = new Image()
  image.src = curVr.imgSrc
  image.onload = function () {
    //æ›´æ–°å›¾ç‰‡
    mat.setMap('u_Sampler', { image })
    //æ›´æ–°ç›¸æœºè§†ç‚¹
    camera.position.set(...curVr.eye)
    orbit.updateCamera()
    orbit.resetSpherical()
    //æ˜¾ç¤ºæ ‡è®°ç‚¹
    showMark()
  }
}

//æ˜¾ç¤ºæ ‡è®°ç‚¹
function showMark() {
  curVr.marks.forEach(ele => {
    const div = document.createElement('div')
    div.className = 'mark'
    div.innerText = ele.name
    div.setAttribute('data-link', ele.link)
    marks.append(div)
  })
}

//æ›´æ–°æ ‡è®°ç‚¹çš„canvasåæ ‡ä½
function updateMarkCp() {
  if (!marks.children.length) { return }
  const { position } = camera
  const EO = target.clone().sub(position)
  curVr.marks.forEach((ele, ind) => {
    const markWp = new Vector3(...ele.pos)
    const mark = marks.children[ind]
    const dot = markWp.clone().sub(position).dot(EO)
    mark.style.display = dot > 0 ? 'block' : 'none'
    const { x, y } = markWp.clone().applyMatrix4(pvMatrix)
    mark.style.left = `${(x + 1) * canvas.width / 2}px`
    mark.style.top = `${(-y + 1) * canvas.height / 2}px`
  })
}


```



5.ç‚¹å‡»æ ‡è®°ç‚¹æ—¶ï¼Œæ ¹æ®æ ‡è®°ç‚¹çš„data-link æ›´æ–°VR

```js
marks.addEventListener('click', ({ target }) => {
  if (target.className !== 'mark') { return }
  marks.innerHTML = ''
  curVr = getVrById(parseInt(target.getAttribute('data-link')))
  updateVr()
})


```



6.è¿ç»­æ¸²æŸ“çš„æ—¶å€™ï¼Œæ›´æ–°æ ‡è®°ç‚¹çš„canvasåæ ‡ä½ã€‚

```js
function render() {
  orbit.getPvMatrix()
  scene.draw()
  updateMarkCp()
  requestAnimationFrame(render)
}


```



7.æŠŠé¼ æ ‡çš„ä½ç§»äº‹ä»¶ç»‘å®šåˆ°windowä¸Šã€‚

å½“é¼ æ ‡ç§»åŠ¨åˆ°æ ‡è®°ç‚¹ä¸Šæ—¶ï¼Œä¼šè¢«æ ‡è®°ç‚¹å¡ä½ï¼Œæ— æ³•ç§»åŠ¨ï¼Œè¿™æ˜¯å› ä¸ºæ ‡è®°ç‚¹æŒ¡ä½äº†canvasï¼Œæ‰€ä»¥ä¸èƒ½å†æŠŠé¼ æ ‡äº‹ä»¶ç»‘å®šåˆ°canvasä¸Šäº†ã€‚

```js
window.addEventListener('pointermove', event => {
  orbit.pointermove(event)
})


```

åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒVR åœºæ™¯åˆ‡æ¢çš„åŸºæœ¬åŠŸèƒ½å·²ç»æå®šäº†ã€‚

ç„¶è€Œï¼Œè€æ¿å¯èƒ½è¿˜ä¼šè®©æˆ‘ä»¬ç»™VRä¸€ä¸ªè¿‡åº¦åŠ¨ç”»ï¼Œå› ä¸ºåˆ«äººå®¶çš„VR ä¹Ÿä¼šæœ‰è¿™æ ·çš„æ•ˆæœã€‚



#### 2-8-VRåœºæ™¯çš„è¿‡åº¦åŠ¨ç”»

å½“å‰æ˜¾ç¤ºçš„VRå°±å«å®ƒæ—§VRï¼Œæ¥ä¸‹æ¥è¦æ˜¾ç¤ºçš„VRå°±å«å®ƒæ–°VRã€‚

è¿™ä¸¤ä¸ªVRå¯ä»¥æƒ³è±¡æˆä¸¤å¼ å›¾ç‰‡ï¼Œæ—§VRåœ¨æ–°VRä¸Šé¢ï¼Œæ—§VRé®æŒ¡äº†æ–°VRã€‚

åœ¨åˆ‡æ¢VRçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå®ç°è¿™æ ·ä¸€ä¸ªè¿‡æ¸¡æ•ˆæœï¼šè®©æ—§VRæ¸éšï¼Œä»è€Œéœ²å‡ºä¸‹é¢çš„æ–°VRã€‚

å¸§ç¼“å†²åŒºä¾¿å¯ä»¥è§†ä¹‹ä¸ºå­˜å‚¨åœ¨å†…å­˜é‡Œçš„å›¾ç‰‡ã€‚

æˆ‘ä»¬å°†ä¸¤ä¸ªVRåœºæ™¯åˆ†åˆ«æ¸²æŸ“åˆ°ä¸¤ä¸ªå¸§ç¼“å†²åŒºé‡Œåï¼Œä¾¿å¯ä»¥åŸºäºé€æ˜åº¦èåˆä¸€ä¸‹ï¼Œç„¶åè´´åˆ°ä¸€ä¸ªå……æ»¡çª—å£çš„å¹³é¢ä¸Šï¼Œä»è€Œå®ç°è¿‡åº¦æ•ˆæœã€‚

1.å°è£…ä¸ªåœºæ™¯å¯¹è±¡å‡ºæ¥ï¼Œè¿™ä¸ªåœºæ™¯é‡Œåªæœ‰ä¸€ä¸ªå……æ»¡çª—å£çš„å¹³é¢ï¼Œä¹‹åä¼šæŠŠå¸§ç¼“å†²åŒºè´´ä¸Šå»ã€‚

- VRPlane.js

```js
import { createProgram } from "./Utils.js";
import Mat from './Mat.js'
import Geo from './Geo.js'
import Obj3D from './Obj3D.js'
import Scene from './Scene.js'
import Rect from './Rect.js'

const vs = `
  attribute vec4 a_Position;
  attribute vec2 a_Pin;
  varying vec2 v_Pin;
  void main(){
    gl_Position=a_Position;
    v_Pin=a_Pin;
  }
`

const fs = `
  precision mediump float;
  uniform float u_Ratio;
  uniform sampler2D u_SampNew;
  uniform sampler2D u_SampOld;
  varying vec2 v_Pin;
  void main(){
    vec4 t1 = texture2D( u_SampNew, v_Pin );
    vec4 t2 = texture2D( u_SampOld, v_Pin );
    gl_FragColor = mix(t2,t1, u_Ratio);
  }
`

export default class VRPlane extends Scene{
  constructor(attr){
    super(attr)
    this.createModel()
  }
  createModel() {
    const { gl } = this
    this.registerProgram('map', {
      program: createProgram(gl,vs,fs),
      attributeNames: ['a_Position', 'a_Pin'],
      uniformNames: ['u_SampNew', 'u_SampOld', 'u_Ratio']
    })
    const mat = new Mat({
      program: 'map',
      data: {
        u_Ratio: {
          value: 0,
          type: 'uniform1f',
        },
      }
    })
    const rect = new Rect(2, 2, 0.5, 0.5)
    const geo = new Geo({
      data: {
        a_Position: {
          array: rect.vertices,
          size: 3
        },
        a_Pin: {
          array: rect.uv,
          size: 2
        }
      },
      index: {
        array: rect.indexes
      }
    })
    this.add(new Obj3D({ geo, mat }))
    this.mat=mat
  }
  
}


```



2.å°è£…ä¸€ä¸ªåŒ…å«VRåœºæ™¯çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚

- VRFrame.js

```js
import { createProgram } from "./Utils.js";
import {Matrix4} from 'https://unpkg.com/three/build/three.module.js';
import Mat from './Mat.js'
import Geo from './Geo.js'
import Obj3D from './Obj3D.js'
import Earth from './Earth.js'
import Frame from './Frame.js'

const vs = `
  attribute vec4 a_Position;
  attribute vec2 a_Pin;
  uniform mat4 u_PvMatrix;
  uniform mat4 u_ModelMatrix;
  varying vec2 v_Pin;
  void main(){
    gl_Position=u_PvMatrix*u_ModelMatrix*a_Position;
    v_Pin=a_Pin;
  }
`
const fs = `
  precision mediump float;
  uniform sampler2D u_Sampler;
  varying vec2 v_Pin;
  void main(){
    gl_FragColor=texture2D(u_Sampler,v_Pin);
  }
`

/* å‚æ•°
  gl,
  orbit,
*/
export default class VRFrame extends Frame{
  constructor(attr){
    super(attr)
    this.createModel()
  }
  createModel() {
    const { orbit, gl } = this

    this.registerProgram('map', {
      program: createProgram(gl,vs,fs),
      attributeNames: ['a_Position', 'a_Pin'],
      uniformNames: ['u_PvMatrix', 'u_ModelMatrix', 'u_Sampler']
    })
    const mat = new Mat({
      program: 'map',
      data: {
        u_PvMatrix: {
          value: orbit.getPvMatrix().elements,
          type: 'uniformMatrix4fv',
        },
        u_ModelMatrix: {
          value: new Matrix4().elements,
          type: 'uniformMatrix4fv',
        },
      },
      maps: {
        u_Sampler: {
          magFilter: gl.LINEAR,
          minFilter: gl.LINEAR,
        }
      }
    })
    const earth = new Earth(0.5, 64, 32)
    const geo = new Geo({
      data: {
        a_Position: {
          array: earth.vertices,
          size: 3
        },
        a_Pin: {
          array: earth.uv,
          size: 2
        }
      },
      index: {
        array: earth.indexes
      }
    })
    this.add(new Obj3D({ geo, mat }))
    this.draw()
    this.mat=mat
  }

}

```



3.åŸºäºä¹‹å‰çš„åœºæ™¯åˆ‡æ¢æ–‡ä»¶ä¿®æ”¹ä»£ç ï¼Œå¼•å…¥ç»„ä»¶ã€‚

```js
import {
  Matrix4, PerspectiveCamera, Vector3
} from 'https://unpkg.com/three/build/three.module.js';
import OrbitControls from './lv/OrbitControls.js'
import VRFrame from './lv/VRFrame.js';
import VRPlane from './lv/VRPlane.js';
import Track from '/jsm/Track.js';

```



4.å¼€å¯é€æ˜åº¦ã€‚

```js
let gl = canvas.getContext('webgl');
gl.enable(gl.BLEND);
gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

```



5.å®ä¾‹åŒ–ä¸€ä¸ªåœºæ™¯å¯¹è±¡ï¼Œä¸¤ä¸ªå¸§ç¼“å†²åŒºã€‚

```js
const scene = new VRPlane({ gl })
const vrNew = new VRFrame({ gl, orbit })
const vrOld = new VRFrame({ gl, orbit })
scene.mat.setMap('u_SampOld', {
  texture: vrOld.texture
})

```

åˆå§‹çŠ¶æ€ï¼Œæ—§VR æ˜¯æ²¡æœ‰å›¾ç‰‡çš„ï¼Œé»˜è®¤ç”»å‡ºæ¥å°±æ˜¯ä¸€å¼ é»‘å›¾ï¼Œå°†å…¶ä¼ ç»™åœºæ™¯å¯¹è±¡çš„u_SampOldåï¼Œä¾¿å¯ä»¥å®ç°åœ¨é»‘æš—ä¸­æ¸ç°æ–°VRçš„æ•ˆæœã€‚

æ–°VR éœ€è¦åœ¨åŠ è½½åˆ°å›¾ç‰‡åï¼Œç”»å‡ºVRï¼Œå†ä¼ ç»™åœºæ™¯å¯¹è±¡çš„u_SampNewã€‚



6.å®ä¾‹åŒ–æ—¶é—´è½¨å¯¹è±¡ã€‚

```js
// æ˜¯å¦åˆ¶ä½œè¡¥é—´åŠ¨ç”»
let tweenable = false
// è¡¥é—´æ•°æ®
let aniDt = { ratio: 0 }
// æ—¶é—´è½¨
let track = new Track(aniDt)
track.timeLen = 1000
track.keyMap = new Map([
  ['ratio', [[0, 0], [1000, 1]]]
])
track.onEnd = () => {
  tweenable = false
}
```



7.åœ¨åˆ‡æ¢å›¾ç‰‡æ—¶ï¼š

- å¼€å¯è¡¥é—´åŠ¨ç”»
- è®¾ç½®æ–°ã€æ—§VRçš„å›¾ç‰‡
- æŠŠæ—§VRçš„çº¹ç†å¯¹è±¡ä¼ å…¥u_SampOld
- æ ¹æ®VR æ•°æ®æ›´æ–°è§†ç‚¹ä½ç½®
- æ ¹æ®VR æ•°æ®æ˜¾ç¤ºæ ‡è®°ç‚¹

```js
//æš‚å­˜å½“å‰çš„VRå›¾åƒ
let tempImg = null
// æ›´æ–°VRå›¾åƒ
function updateVr() {
  const image = new Image()
  image.src = curVr.imgSrc
  image.onload = function () {
    //å¼€å¯è¡¥é—´åŠ¨ç”»
    tweenable = true
    //æ—¶é—´è½¨èµ·å§‹æ—¶é—´
    track.start = new Date()
    
    //è‹¥tempImg ä¸ä¸ºnull
    if (tempImg) {
      // è®¾ç½®æ—§VRçš„å›¾ç‰‡
      vrOld.mat.setMap('u_Sampler', { image: tempImg })
      vrOld.draw()
      // æŠŠæ—§VRçš„çº¹ç†å¯¹è±¡ä¼ å…¥u_SampOld
      scene.mat.setMap('u_SampOld', {
        texture: vrOld.texture
      })
    }
    //æš‚å­˜å½“å‰å›¾ç‰‡
    tempImg = image
    //è®¾ç½®æ–°VRçš„å›¾ç‰‡
    vrNew.mat.setMap('u_Sampler', { image })
    //è®¾ç½®ç›¸æœºè§†ç‚¹
    camera.position.set(...curVr.eye)
    orbit.updateCamera()
    orbit.resetSpherical()
    //æ˜¾ç¤ºå½“å‰VRçš„æ ‡è®°ç‚¹
    showMark()
  }
}
```

å°†ä¹‹å‰ Mat.js å¯¹è±¡çš„setMap æ–¹æ³•åšä¸‹è°ƒæ•´ã€‚

```js
setMap(key,val) {
  const obj = this.maps[key]
  val.needUpdate = true
  if (obj) {
    Object.assign(obj,val)
  } else {
    this.maps[key]=val
  }
}


```

è¿™æ ·ï¼Œè‹¥keyåœ¨mapsä¸­å­˜åœ¨ï¼Œå°±åˆå¹¶valï¼›è‹¥ä¸å­˜åœ¨ï¼Œå°±å†™å…¥valã€‚



8.è¿ç»­æ¸²æŸ“ã€‚

```js
function render() {
  if (tweenable) {
    // æ›´æ–°æ—¶é—´è½¨çš„æ—¶é—´
    track.update(new Date())
    // æ›´æ–°åœºæ™¯å¯¹è±¡çš„æ’å€¼æ•°æ®
    scene.mat.setData('u_Ratio', {
      value: aniDt.ratio
    })
  }
  // æ›´æ–°æŠ•å½±è§†å›¾çŸ©é˜µ
  orbit.getPvMatrix()
  // æ–°VRç»˜å›¾
  vrNew.draw()
  // æ›´æ–°åœºæ™¯å¯¹è±¡çš„u_SampNew
  scene.mat.setMap('u_SampNew', {
    texture: vrNew.texture
  })
  //åœºæ™¯å¯¹è±¡ç»˜å›¾
  scene.draw()
  // æ›´æ–°æ ‡è®°ç‚¹çš„canvasåæ ‡
  updateMarkCp()

  requestAnimationFrame(render)
}


```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å®ç°VRåœºæ™¯çš„é€æ˜åº¦è¡¥é—´åŠ¨ç”»ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å†ä¸°å¯Œä¸€ä¸‹è¡¥é—´åŠ¨ç”»æ•ˆæœã€‚



9.åœ¨é€æ˜åº¦åŠ¨ç”»çš„åŸºç¡€ä¸Šï¼Œå†è®©æ—§VRåšä¸€ä¸ªæ”¾å¤§æ•ˆæœï¼Œç»™ç”¨æˆ·è¥é€ ä¸€ä¸ªæ‹‰è¿›è§†å£çš„æ•ˆæœï¼Œä½¿é¡¹ç›®çœ‹èµ·æ¥æ›´åŠ èµ°å¿ƒã€‚

```java
precision mediump float;
uniform float u_Ratio;
uniform sampler2D u_SampNew;
uniform sampler2D u_SampOld;
varying vec2 v_Pin;
void main(){
  vec2 halfuv=vec2(0.5,0.5);
  float scale=1.0-u_Ratio*0.1;
  vec2 pin=(v_Pin-halfuv)*scale+halfuv;
  vec4 t1 = texture2D( u_SampNew, v_Pin );
  vec4 t2 = texture2D( u_SampOld, pin );
  gl_FragColor = mix(t2,t1, u_Ratio);
}

```

æ”¾å¤§æ—§VRçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥ä»æ¨¡å‹ã€ç›¸æœºã€ç‰‡å…ƒç€è‰²å™¨ç­‰æ–¹é¢æ¥å®ç°ã€‚

æˆ‘è¿™é‡Œå°±æ‰¾äº†ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹æ³•ï¼Œåœ¨ç‰‡å…ƒç€è‰²å™¨é‡Œæ”¾å¤§æ—§VRã€‚

åœ¨ç‰‡å…ƒç€è‰²å™¨é‡Œæ”¾å¤§æ—§VR çš„æ–¹æ³•ï¼Œè‡³å°‘æœ‰ä¸¤ç§ï¼š

- åŸºäºç‰‡å…ƒæ”¾å¤§æ—§VR
- åŸºäºUVæ”¾å¤§æ—§VR

åŸºäºç‰‡å…ƒæ”¾å¤§æ—§VRï¼Œéœ€è¦åœ¨ç‰‡å…ƒç€è‰²å™¨é‡ŒçŸ¥é“canvasç”»å¸ƒåœ¨gl_FragCoord åæ ‡ç³»é‡Œçš„ä¸­å¿ƒç‚¹ï¼Œæœ‰ç‚¹éº»çƒ¦ã€‚

åŸºäºUVæ”¾å¤§æ—§VRï¼Œç›´æ¥åŸºäºuv åæ ‡ç³»çš„ä¸­å¿ƒç‚¹(0.5,0.5) ç¼©å°uvåæ ‡å³å¯ï¼Œæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æˆ‘å°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ”¾å¤§æ—§VRäº†ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒVRç›¸å…³çš„æ ¸å¿ƒåŸç†ç®—æ˜¯å‘Šä¸€æ®µè½äº†ã€‚

ç”¨è¿‡åŸç”Ÿwebgl åšé¡¹ç›®ï¼Œå¤§å®¶å¯ä»¥å‘ç°ä¸€ä¸ªå¥½å¤„ï¼Œåªè¦åº•å­æ‰å®ï¼Œå°±ä¸ä¼šç•æƒ§å„ç§æ–°éœ€æ±‚ã€æ–°åŠŸèƒ½ï¼Œå› ä¸ºä½ ä¼šæ‹¥æœ‰æ›´å¤šã€æ›´è‡ªç”±ã€æ›´çµæ´»çš„é€‰æ‹©ï¼Œä»è€Œæ‰¾åˆ°é—®é¢˜æœ€ä¼˜çš„è§£ã€‚



### 3-çº¿æ¡çš„çº¹ç†æ˜ å°„

æŒ‰ç†æ¥è¯´ï¼Œçº¿æ¡æ˜¯ä¸€æ¡æ²¡æœ‰å®½åº¦çš„çº¿ï¼Œå®ƒæ˜¯æ˜¾ç¤ºä¸å‡ºæ¥çš„ã€‚

ç„¶è€Œï¼Œåœ¨å®é™…ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°†ä¸€äº›ç±»ä¼¼çº¿æ¡ã€æœ‰ä¸€å®šå®½åº¦çš„ä¸œè¥¿ç†è§£ä¸ºçº¿æ¡ï¼Œæ¯”å¦‚é’ˆçº¿ã€è€³æœºçº¿ã€äº¤é€šè·¯çº¿ç­‰ã€‚

æˆ‘ä»¬åœ¨æ˜¾ç¤ºè¿™æ ·çš„çº¿çš„æ—¶å€™ï¼Œæ˜¯éœ€è¦ç”¨æœ‰å®½åº¦çš„çº¿æ¥æ˜¾ç¤ºçš„ã€‚

ä¹‹å‰åœ¨è¯´WebGLå›¾å½¢çš„æ—¶å€™è¯´è¿‡ï¼ŒWebGLæœ‰LINESã€LINE_STRIPã€LINE_LOOP  ä¸‰ç§ç”»çº¿çš„æ–¹æ³•ã€‚

ä¸è¿‡ï¼Œä¸‰ç§æ–¹æ³•åªèƒ½ç»˜åˆ¶ä¸€ä¸ªåƒç´ å®½çš„çº¿ï¼Œæˆ‘è¦æƒ³ç”»çš„æ˜¯ä¸‹å›¾ä¸­ç²—ç‚¹çš„å…¬è·¯ã€‚

![image-20220302153420819](images/image-20220302153420819.png)



è¿™æ¡å…¬è·¯çš„ç»˜åˆ¶è¦åˆ†ä¸¤éƒ¨åˆ†è€ƒè™‘ï¼š

- å®½åº¦çº¿
- çº¹ç†æ˜ å°„

#### 

#### 3-1-è®¤è¯†å®½åº¦çº¿

å½“çº¿æœ‰äº†å®½åº¦ä¹‹åï¼Œå®ƒå°±ä¸ä»…ä»…æ˜¯æœ‰äº†å®½åº¦é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºè¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”±çº¿è½¬é¢ï¼Œæå‡äº†ä¸€ä¸ªç»´åº¦çš„é—®é¢˜ã€‚è¿™ä¼šå»¶ä¼¸å‡ºè®¸å¤šé™¤å®½åº¦ä¹‹å¤–çš„å…¶å®ƒç‰¹æ€§ã€‚

å¯¹äºæœ‰å®½åº¦çš„çº¿ï¼Œcanvas 2d å°±åšå¾—å¾ˆå¥½ï¼Œæ‰€ä»¥å’±ä»¬å…ˆé€šè¿‡canvas 2d è®¤è¯†ä¸€ä¸‹æœ‰å®½åº¦çš„çº¿çš„ç‰¹æ€§ï¼š

- lineWidth å®šä¹‰æè¾¹çš„å®½åº¦ï¼Œå®ƒæ˜¯ä»è·¯å¾„çš„ä¸­å¿ƒå¼€å§‹ç»˜åˆ¶çš„ï¼Œå†…å¤–å„å å®½åº¦çš„ä¸€åŠã€‚

![image-20220223192513802](images/image-20220223192513802.png)



- lineCap çº¿æ¡ç«¯ç‚¹æ ·å¼  

![image-20220223192550511](images/image-20220223192550511.png)



- lineJoin æ‹è§’ç±»å‹  

![image-20220223192626500](images/image-20220223192626500.png)



- miterLimit é™åˆ¶å°–è§’

  å½“lineJoin ä¸ºmiter æ—¶ï¼Œè‹¥æ‹è§’è¿‡å°ï¼Œæ‹è§’çš„åšåº¦å°±ä¼šè¿‡å¤§ã€‚

![image-20220223192755083](images/image-20220223192755083.png)



â€‹	miterLimit=1 åï¼Œå¯é¿å…æ­¤é—®é¢˜

![image-20220223192817229](images/image-20220223192817229.png)



- setLineDash(segments) è™šçº¿ 

  ctx.setLineDash([ 60, 90 ])

![image-20220223192857006](images/image-20220223192857006.png)



â€‹		ctx.setLineDash([ 60, 90, 120 ])  

![image-20220223192933781](images/image-20220223192933781.png)



- lineDashOffset è™šçº¿åç§»  

  ctx.lineDashOffset=0

![image-20220223193048837](images/image-20220223193048837.png)

â€‹		ctx.lineDashOffset=-60

![image-20220223193107721](images/image-20220223193107721.png)



#### 3-2-å®½åº¦çº¿çš„ç»˜åˆ¶æ€è·¯

- ç€è‰²å™¨ç»˜å›¾ï¼šå…ˆç”¨WebGL åŸç”Ÿæ–¹æ³•ç»˜åˆ¶å•åƒç´ çš„çº¿ï¼Œç„¶ååˆ©ç”¨å¸§ç¼“å†²åŒºä¸ºå…¶æè¾¹ã€‚
  
  ![image-20220225124121532](images/image-20220225124121532.png)

  - ä¼˜ç‚¹ï¼šç®€å•å¿«é€Ÿï¼Œå¯ä»¥ç”»å‡ºæ‹è§’å’Œç«¯ç‚¹éƒ½ä¸ºround ç±»å‹çš„çº¿
  - ç¼ºç‚¹ï¼šéš¾ä»¥æ§åˆ¶å…¶ç«¯ç‚¹å’Œæ‹è§’æ ·å¼ï¼Œæ— æ³•åšçº¹ç†æ˜ å°„ï¼Œæ— æ³•æ·±åº¦æµ‹è¯•
  
  
  
- é¡¶ç‚¹å»ºæ¨¡ï¼ŒåŸºäºçº¿æ¡è·¯å¾„ï¼Œå‘å…¶å†…å¤–ä¸¤ä¾§æŒ¤å‹çº¿æ¡ã€‚
  
  ![image-20220228223203790](images/image-20220228223203790.png)
  
  - ä¼˜ç‚¹ï¼šå¯æ§æ€§å¼ºï¼Œå¯æ»¡è¶³å„ç§çº¿æ¡ç‰¹æ€§ï¼Œå¯åšçº¹ç†æ˜ å°„ï¼Œæ”¯æŒæ·±åº¦æµ‹è¯•
  - ç¼ºç‚¹ï¼šé¡¶ç‚¹ç‚¹ä½çš„è®¡ç®—é‡æœ‰ç‚¹å¤§ã€‚

å› ä¸ºæˆ‘ä»¬è¦ä¸ºå®½åº¦çº¿è´´å›¾ï¼Œæ‰€ä»¥æˆ‘å°±ç”¨é¡¶ç‚¹å»ºæ¨¡çš„æ–¹å¼ç»˜åˆ¶æœ‰å®½åº¦çš„çº¿äº†ã€‚

æˆ‘ä»¬å…ˆç”¨æœ€ç®€å•çš„æ–¹å¼ç”»ä¸€æ¡å®½åº¦çº¿ï¼šåƒcanvas 2dé‚£æ ·ï¼Œä»¥lineCapä¸ºbuttï¼ŒlineJoin ä¸ºmiterçš„æ–¹å¼ç»˜åˆ¶ã€‚



#### 3-3-å®½åº¦çº¿çš„æŒ¤å‹åŸç†

å®½åº¦çº¿ä¸­ç›¸é‚»çš„ä¸¤æ¡çº¿æ®µå­˜åœ¨ä¸¤ç§å…³ç³»ï¼š

- ç›¸äº¤

  ![image-20220228223203790](images/image-20220228223203790.png)



- å¹³è¡Œ

  ![image-20220227150114476](images/image-20220227150114476.png)





æŒ¤å‹é¡¶ç‚¹çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š

- å‚ç›´æŒ¤å‹ï¼Œå¯¹åº”çº¿æ¡ç«¯ç‚¹æˆ–ç›¸é‚»çº¿æ®µå¹³è¡Œæ—¶çš„ç‚¹ã€‚
- éå‚ç›´æŒ¤å‹ï¼Œå¯¹åº”ç›¸é‚»çº¿æ®µä¸å¹³è¡Œæ—¶çš„ç‚¹ï¼Œå³ç›¸äº¤çº¿æ®µçš„æ‹ç‚¹ã€‚



#### 3-4-å‚ç›´æŒ¤å‹ç‚¹

ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼š

![image-20220227150114476](images/image-20220227150114476.png)

å·²çŸ¥ï¼š

- ç‚¹Aã€ç‚¹B
- çº¿æ¡å®½åº¦ä¸ºlineWidth
- A1ã€A2æ˜¯è‡ªç‚¹A æ²¿ABæ–¹å‘å‚ç›´æŒ¤å‹å‡ºçš„ç‚¹

æ±‚ï¼šA1ã€A2

è§£ï¼š

è®¡ç®—çº¿æ¡å®½åº¦çš„ä¸€åŠhï¼š

```
h=lineWidth/2
```

ç”±ç‚¹Aã€ç‚¹Bè®¡ç®—å‘é‡ABï¼š

```
AB(x,y)=B-A
```

å°†å‘é‡ABé€†æ—¶é’ˆæ—‹è½¬90Â°ï¼Œè®¾ç½®é•¿åº¦ä¸ºhï¼Œå¾—ç‚¹A1ï¼š

```
A1=h*(-y,x)/|(-y,x)|
```

å°†å‘é‡ABé¡ºæ—¶é’ˆæ—‹è½¬90Â°ï¼Œè®¾ç½®é•¿åº¦ä¸ºhï¼Œå¾—ç‚¹A2ï¼š

```
A2=h*(y,-x)/|(y,-x)|
```

æŒ¤å‹ç«¯ç‚¹C åçš„ç‚¹C1ã€C2 äº¦æ˜¯åŒç†ã€‚

è‡³äºæŒ¤å‹ä¸­é—´ç‚¹B åçš„B1ã€B2ï¼Œè‹¥ç‚¹Bç›¸é‚»çš„çº¿æ®µå¹³è¡Œï¼Œå…¶è®¡ç®—æ–¹æ³•äº¦æ˜¯åŒç†ã€‚

ABæ˜¯å¦å¹³è¡ŒäºBCçš„åˆ¤æ–­æ–¹æ³•ï¼š

```
(Math.atan2(AB.y,AB.x)-Math.atan2(BC.y,BC.x))%Math.PI
```



#### 3-4-è®¡ç®—æ‹ç‚¹



![image-20220227221618138](images/image-20220227221618138.png)



å·²çŸ¥ï¼š

- ç‚¹Aã€ç‚¹Bã€ç‚¹C
- çº¿æ¡å®½åº¦ä¸ºlineWidth
- ABã€BC ä¸å¹³è¡Œ

æ±‚ï¼šæ‹ç‚¹B1ã€B2

æ€è·¯ï¼š

æ±‚æ‹ç‚¹çš„æœ¬è´¨ï¼Œå°±æ˜¯æ±‚ä¸¤æ¡ç›´çº¿çš„çš„äº¤ç‚¹ã€‚

æ±‚ç›´çº¿äº¤ç‚¹çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œé«˜ä¸­æ•°å­¦æœ‰ä¸€ä¸ªç”¨ç›´çº¿ä¸€èˆ¬å¼æ±‚äº¤ç‚¹çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨å‘é‡æ¨å¯¼ã€‚

è§£ï¼š

ç”±å·²çŸ¥æ¡ä»¶å¯çŸ¥ï¼š

```
BDâˆ¥EB2
BEâˆ¥DB2
|BF|=|BG|
```

æ‰€ä»¥ï¼š

BEB2D æ˜¯ç­‰è¾¹å¹³è¡Œå››è¾¹å½¢ã€‚

è®¡ç®—å‘é‡BDçš„å•ä½å‘é‡dï¼š

```
d=AB/|AB| 
```

è®¡ç®—å‘é‡BEçš„å•ä½å‘é‡eï¼š

```
e=CB/|CB|
```

ç”±ç­‰è¾¹å¹³è¡Œå››è¾¹å½¢å®šç†ï¼Œå¯æ±‚å¾—BB2 çš„å•ä½å‘é‡bï¼š

```js
b=(d+e)/|d+e|
```

æ¥ä¸‹æ¥ï¼Œåªè¦æ±‚å¾—BB2çš„é•¿åº¦ï¼Œä¾¿å¯çŸ¥é“ç‚¹B2ã€‚

ç”±å‘é‡çš„ç‚¹ç§¯å…¬å¼å¯çŸ¥ï¼š

```
cosâˆ B2BG=(BGÂ·b)/(|BG|*|b|)
```

å› ä¸ºï¼š

bæ˜¯å•ä½å‘é‡

æ‰€ä»¥ï¼š

```
cosâˆ B2BG=(BGÂ·b)/|BG|
```

ç”±ä½™å¼¦å…¬å¼å¯çŸ¥ï¼š

```
cosâˆ B2BG=|BG|/|BB2|
|BB2|=|BG|/cosâˆ B2BG
```

æ‰€ä»¥ï¼š

```
BB2=b*|BB2|
```

æ‰€ä»¥ï¼š

```js
B2=BB2+B
```

çŸ¥é“äº†B2åï¼ŒB1ä¹Ÿå°±å¥½æ±‚äº†ï¼š

```
B1=-BB2+B
```

è¿™ä¾¿æ˜¯ç”¨å‘é‡æ¨å¯¼æ‹ç‚¹çš„æ–¹æ³•ã€‚

å¯¹äºç”¨ç›´çº¿çš„ä¸€èˆ¬å¼æ±‚äº¤ç‚¹çš„æ–¹æ³•ï¼Œæˆ‘å°±ä¸ç»†è¯´äº†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘çš„[ç›¸å…³æ–‡ç« ](http://yxyy.name/blog/md.html?ossName=162765212208629481006223312756.md&title=%E6%BC%AB%E8%B0%88%E7%9B%B4%E7%BA%BF%E4%B9%8B%E7%82%B9%E6%96%9C%E5%BC%8F%E5%92%8C%E4%B8%80%E8%88%AC%E5%BC%8F)ã€‚

æ¥ä¸‹æ¥å’±ä»¬è¯´ä¸€ä¸‹ä»£ç å®ç°ã€‚



#### 3-5-ç»˜åˆ¶å®½åº¦çº¿

1.å»ºç«‹ä¸€ä¸ªBoldLine å¯¹è±¡

```js
import {Vector2} from 'https://unpkg.com/three/build/three.module.js';

/*
å±æ€§ï¼š
  points:çº¿æ¡èŠ‚ç‚¹,äºŒç»´ï¼Œ[Vector2,Vector2,â€¦â€¦]
  lineWidthï¼šçº¿å®½
  verticesï¼šé¡¶ç‚¹é›†åˆ
  normalsï¼šæ³•çº¿é›†åˆ
  indexesï¼šé¡¶ç‚¹ç´¢å¼•é›†åˆ
  uvï¼šuvåæ ‡é›†åˆ
*/
export default class BoldLine{
  constructor(points=[],lineWidth=1){
    this.points=points
    this.lineWidth=lineWidth
    this.vertices=null
    this.normals=null
    this.indexes = null
    this.uv = null
    this.init()
  }
  init() {
    const { points,lineWidth:h } = this
    const len = points.length
    if (len < 2) { return }
    
    // æŒ¤å‹çº¿æ¡ï¼Œè·å–é¡¶ç‚¹
    const extrudePoints=this.extrude()
    
    // é¡¶ç‚¹é›†åˆ
    const vertices = []
    // é¡¶ç‚¹ç´¢å¼•
    const indexes = []
    
    // ä»¥çº¿æ®µæŒ¤å‹å‡ºçš„å››è¾¹å½¢ä¸ºå•ä½ï¼Œæ„å»ºé¡¶ç‚¹é›†åˆã€é¡¶ç‚¹ç´¢å¼•
    const len1 = points.length - 1
    for (let i = 0; i < len1; i++) {
      //å››è¾¹å½¢çš„4ä¸ªé¡¶ç‚¹
      const pi=i * 2
      const [A1, A2, B1, B2] = [
        extrudePoints[pi],
        extrudePoints[pi+1],
        extrudePoints[pi+2],
        extrudePoints[pi+3],
      ]
      vertices.push(
        ...A1, ...A2, ...B1, ...B2
      )
      // é¡¶ç‚¹ç´¢å¼•
      const A1i = i * 4
      const A2i = A1i+1
      const B1i = A1i+2
      const B2i = A1i + 3
      indexes.push(
        A1i,A2i,B1i,
        B1i,A2i,B2i
      )
    }
    
    this.vertices=new Float32Array(vertices)
    this.indexes=new Uint16Array(indexes)
  }

  // æŒ¤å‹çº¿æ¡
  extrude() {
    const { points } = this
    //çº¿å®½çš„ä¸€åŠ
    const h = this.lineWidth / 2
    //é¡¶ç‚¹é›†åˆï¼ŒæŒ¤å‹èµ·å§‹ç‚¹ç½®å…¥å…¶ä¸­
    const extrudePoints = [
      ...this.verticalPoint(points[0],points[1],h)
    ]
    // æŒ¤å‹çº¿æ¡å†…éƒ¨ç‚¹ï¼Œç½®å…¥extrudePoints
    const len1=points.length-1
    const len2=len1-1
    for (let i = 0; i < len2; i++){
      // ä¸‰ä¸ªç‚¹,ä¸¤æ¡çº¿
      const A=points[i]
      const B=points[i+1]
      const C = points[i + 2]
      // ä¸¤æ¡çº¿æ˜¯å¦ç›¸äº¤
      if (this.intersect(A,B,C)) {
        extrudePoints.push(...this.interPoint(A, B, C, h))
      } else {
        extrudePoints.push(...this.verticalPoint(B, C, h))
      }
    }
    // æŒ¤å‹æœ€åä¸€ä¸ªç‚¹
    extrudePoints.push(...this.verticalPoint(
      points[len2], points[len1], h, points[len1]
    ))
    return extrudePoints
  }

  // åˆ¤æ–­ä¸¤æ¡ç›´çº¿æ˜¯å¦ç›¸äº¤
  intersect(A,B,C) {
    const angAB=B.clone().sub(A).angle ()
    const angBC = C.clone().sub(B).angle ()
    return !!(angAB-angBC)%Math.PI
  }
  //å‚ç›´æŒ¤å‹ç‚¹
  verticalPoint(A,B,h,M=A) {
    const {x,y} = B.clone().sub(A)
    return [
      new Vector2(-y, x).setLength(h).add(M),
      new Vector2(y,-x).setLength(h).add(M)
    ]
  }
  // æ‹ç‚¹
  interPoint(A, B, C, h) {
    const d=B.clone().sub(A).normalize()
    const e = B.clone().sub(C).normalize()
    const b = d.clone().add(e).normalize()
    const BG = new Vector2(d.y, -d.x).setLength(h)
    const BGLen=BG.length()
    const cos = BG.clone().dot(b) / BGLen
    const BB2 = b.setLength(BGLen / cos)
    const BB1 = BB2.clone().negate()
    return [
      BB1.add(B),
      BB2.add(B)
    ]
  }
}
```



2.ç»˜åˆ¶å®½åº¦çº¿

```html
<canvas id="canvas"></canvas>
<script id="vs" type="x-shader/x-vertex">
    attribute vec4 a_Position;
    void main(){
      gl_Position = a_Position;
    }
</script>
<script id="fs" type="x-shader/x-fragment">
    precision mediump float;
    void main(){
      gl_FragColor=vec4(1.0);
    }
</script>
<script type="module">
  import { createProgram, imgPromise } from './lv/Utils.js';
  import { Matrix4, PerspectiveCamera, Vector3, Vector2 } from 'https://unpkg.com/three/build/three.module.js';
  import OrbitControls from './jsm/OrbitControls.js'
  import Mat from './lv/Mat.js'
  import Geo from './lv/Geo.js'
  import Obj3D from './lv/Obj3D.js'
  import Scene from './lv/Scene.js'
  import BoldLine from './lv/BoldLine.js'

  const canvas = document.getElementById('canvas');
  canvas.width = 900;
  canvas.height = 900;
  let gl = canvas.getContext('webgl');

  // åœºæ™¯
  const scene = new Scene({ gl })
  // æ³¨å†Œç¨‹åºå¯¹è±¡
  scene.registerProgram(
    'line',
    {
      program: createProgram(
        gl,
        document.getElementById('vs').innerText,
        document.getElementById('fs').innerText
      ),
      attributeNames: ['a_Position'],
    }
  )
  const mat = new Mat({
    program: 'line',
    mode: 'TRIANGLES'
  })

  const line = new BoldLine([
    new Vector2(-0.7, 0),
    new Vector2(-0.4, 0),
    new Vector2(-0.4, 0.4),
    new Vector2(0.3, 0.4),
    new Vector2(-0.3, -0.4),
    new Vector2(0.4, -0.4),
    new Vector2(0.4, 0),
    new Vector2(0.7, 0.4),
  ], 0.2)

  const geo = new Geo({
    data: {
      a_Position: {
        array: line.vertices,
        size: 2
      },
    },
    index: {
      array: line.indexes
    }
  })
  scene.add(new Obj3D({ geo, mat }))
  scene.draw()
</script>	
```

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220302162610507](images/image-20220302162610507.png)



#### 3-6-å®½åº¦çº¿è´´å›¾æ€è·¯

![image-20220316190207708](images/image-20220316190207708.png)

1.ä»¥çº¿æ®µæŒ¤å‡ºçš„å››è¾¹å½¢ä¸ºå•ä½è¿›è¡Œè´´å›¾ã€‚

2.è´´å›¾çš„æ—¶å€™ï¼Œä¸ºäº†æ–¹ä¾¿åšçº¹ç†æ˜ å°„ï¼Œå¯ä»¥å…ˆè®©æ¯ä¸€ä¸ªå››è¾¹å½¢èººå¹³ï¼Œå†åšçº¹ç†æ˜ å°„ã€‚

3.ä¸ºäº†é¿å…è´´å›¾æ‹‰ä¼¸ï¼Œå¯åŸºäºçº¿å®½ï¼Œè®¾ç½®è´´å›¾åœ¨uå‘çš„reapeat ç³»æ•°ã€‚

ä¸¾ä¸ªä¾‹å­ã€‚

å·²çŸ¥ï¼š

- è´´å›¾æ˜¯ä¸€ä¸ªæ­£æ–¹å½¢å›¾ç‰‡ã€‚


- çº¿å®½ä¸ºh

æ±‚ï¼šåˆ™ç‚¹B1ã€B2ã€C1ã€C2æ‰€å¯¹åº”çš„uvåæ ‡

è§£ï¼š

```
B1:(B12.x/h,1)
B2:(B22.x/h,0)
C1:(C12.x/h,1)
C2:(C22.x/h,0)
```



#### 3-7-å®½åº¦çº¿è´´å›¾ä»£ç 

1.åœ¨BoldLine.js ä¸­è®¡ç®—uvåæ ‡ã€‚

```js
init() {
  const { points,lineWidth:h } = this
  const len = points.length
  if (len < 2) { return }

  // æŒ¤å‹çº¿æ¡ï¼Œè·å–é¡¶ç‚¹
  const extrudePoints=this.extrude()

  // é¡¶ç‚¹é›†åˆ
  const vertices = []
  // é¡¶ç‚¹ç´¢å¼•
  const indexes = []
  // uv åæ ‡
  const uv=[]

  // ä»¥çº¿æ®µæŒ¤å‹æˆçš„å››è¾¹å½¢ä¸ºå•ä½ï¼Œæ„å»ºé¡¶ç‚¹é›†åˆã€é¡¶ç‚¹ç´¢å¼•ã€uv
  const len1 = points.length - 1
  for (let i = 0; i < len1; i++) {
    //å››è¾¹å½¢çš„4ä¸ªé¡¶ç‚¹
    const pi=i * 2
    const [A1, A2, B1, B2] = [
      extrudePoints[pi],
      extrudePoints[pi+1],
      extrudePoints[pi+2],
      extrudePoints[pi+3],
    ]
    vertices.push(
      ...A1, ...A2, ...B1, ...B2
    )
    // é¡¶ç‚¹ç´¢å¼•
    const A1i = i * 4
    const A2i = A1i+1
    const B1i = A1i+2
    const B2i = A1i + 3
    indexes.push(
      A1i,A2i,B1i,
      B1i,A2i,B2i
    )
    //é€†å‘æ—‹è½¬å››è¾¹å½¢
    const ang = -B1.clone().sub(A1).angle()
    const O = new Vector2()
    const [lb, rt, rb] = [
      A2.clone().sub(A1).rotateAround(O,ang),
      B1.clone().sub(A1).rotateAround(O,ang),
      B2.clone().sub(A1).rotateAround(O,ang),
    ]
    uv.push(
      0, 1,        //A1
      lb.x / h, 0, //A2
      rt.x / h, 1, //B1
      rb.x / h, 0, //B2
    )
  }

  this.vertices = new Float32Array(vertices)
  this.uv=new Float32Array(uv)
  this.indexes=new Uint16Array(indexes)
}
```



2.ç»˜åˆ¶å®½åº¦çº¿

```html
<canvas id="canvas"></canvas>
<script id="vs" type="x-shader/x-vertex">
    attribute vec4 a_Position;
    attribute vec2 a_Pin;
    varying vec2 v_Pin;
    void main(){
      gl_Position = a_Position;
      v_Pin=a_Pin;
      gl_PointSize=10.0;
    }
</script>
<script id="fs" type="x-shader/x-fragment">
    precision mediump float;
    uniform sampler2D u_Sampler;
    varying vec2 v_Pin;
    void main(){
      gl_FragColor=texture2D(u_Sampler,v_Pin);
    }
</script>
<script type="module">
  import { createProgram, imgPromise } from './lv/Utils.js';
  import { Matrix4, PerspectiveCamera, Vector3, Vector2 } from 'https://unpkg.com/three/build/three.module.js';
  import OrbitControls from './jsm/OrbitControls.js'
  import Mat from './lv/Mat.js'
  import Geo from './lv/Geo.js'
  import Obj3D from './lv/Obj3D.js'
  import Scene from './lv/Scene.js'
  import BoldLine from './lv/BoldLine.js'

  const canvas = document.getElementById('canvas');
  canvas.width = 900;
  canvas.height = 900;
  let gl = canvas.getContext('webgl');

  // åœºæ™¯
  const scene = new Scene({ gl })
  // æ³¨å†Œç¨‹åºå¯¹è±¡
  scene.registerProgram(
    'line',
    {
      program: createProgram(
        gl,
        document.getElementById('vs').innerText,
        document.getElementById('fs').innerText
      ),
      attributeNames: ['a_Position', 'a_Pin'],
      uniformNames: ['u_Sampler']
    }
  )
  const mat = new Mat({
    program: 'line',
    mode: 'TRIANGLES'
  })

  const line = new BoldLine([
    new Vector2(-0.7, 0),
    new Vector2(-0.4, 0),
    new Vector2(-0.4, 0.4),
    new Vector2(0.3, 0.4),
    new Vector2(-0.3, -0.4),
    new Vector2(0.4, -0.4),
    new Vector2(0.4, 0),
    new Vector2(0.7, 0.4),
  ], 0.2)

  const geo = new Geo({
    data: {
      a_Position: {
        array: line.vertices,
        size: 2
      },
      a_Pin: {
        array: line.uv,
        size: 2
      }
    },
    index: {
      array: line.indexes
    }
  })
  scene.add(new Obj3D({ geo, mat }))

  const image = new Image()
  image.src = `./images/road.jpg`
  image.onload = function () {
    mat.setMap('u_Sampler', {
      image
    })
    scene.draw()
  }
</script>
```



3.å¯¹Mat.js å¯¹è±¡é‡Œçš„updateMap() æ–¹æ³•ç¨ä½œè°ƒæ•´ï¼Œåˆ¤æ–­ä¸€ä¸‹è¦æ›´æ–°çš„è´´å›¾é‡Œæœ‰æ²¡æœ‰çº¹ç†å¯¹è±¡textureï¼Œè‹¥æ²¡æœ‰ï¼Œå°±æ–°å»ºä¸€ä¸ªã€‚

```js
updateMap(gl, map, ind) {
  const {
    format = gl.RGB,
    image,
    wrapS,
    wrapT,
    magFilter,
    minFilter,
    texture
  } = map
  if (!texture) {
    map.texture = gl.createTexture()
  }
  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, 1)
  gl.activeTexture(gl[`TEXTURE${ind}`])
  gl.bindTexture(gl.TEXTURE_2D, map.texture)
  â€¦â€¦
}
```



æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220302153420819](images/image-20220302153420819.png)





## æ€»ç»“

å› ä¸ºæ—¶é—´åŸå› ï¼Œwebgl çŸ¥è¯†æš‚ä¸”å‘Šä¸€æ®µè½ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¯¹webglåŸºç¡€çŸ¥è¯†çš„å……èƒ½å·²ç»è¶³å¤Ÿäº†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šå¸¦å¤§å®¶å¿«é€Ÿå…¥é—¨three.jsï¼Œç„¶åè¿›å…¥å®æˆ˜ã€‚

ç­‰è¯´å®Œå®æˆ˜ï¼Œæˆ‘ä¼šå›å¤´ç»§ç»­è¯´webgl å’Œå›¾å½¢å­¦ï¼Œé¢„è®¡ä¼šåŒ…å«ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š

- Fragment Shader è¿›é˜¶
- å‚…é‡Œå¶å˜æ¢ï¼ŒæŠ—é”¯é½¿ã€è‚Œç†
- ç”¨çº¹ç†åˆ¶ä½œç¯å¢ƒå…‰ã€å‡¹å‡¸è´´å›¾ã€æ³•çº¿è´´å›¾
- åˆ©ç”¨ä¸‰è§’å½¢é‡å¿ƒåæ ‡å¼€å‘å…‰æ …å¼•æ“
- çº¹ç†æ»¤æ³¢å™¨çš„å†…éƒ¨å®ç°åŸç†
- å¾®ç§¯åˆ†ï¼Œå›¾å½¢å­¦è¿›é˜¶çš„å¿…ç»ä¹‹è·¯
- å…‰çº¿è¿½è¸ªï¼Œæ¥è¿‘çœŸå®è‡ªç„¶çš„æ¸²æŸ“ç®—æ³•
- æµä½“åŠ¨åŠ›å­¦ä»¿çœŸ
- ä¸‰ç»´æ¨¡å‹å¸ƒå°”è¿ç®—



